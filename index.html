<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f3f1ec;--surface:#fff;--surface-alt:#faf9f6;--border:#e2ddd4;
  --text:#2c2418;--text-s:#7a6f5f;--text-m:#a89e8e;
  --accent:#6b5b45;--accent-h:#554832;--accent-l:#f0ebe2;
  --green:#4a7a52;--green-l:#edf5ee;--red:#a04040;--red-l:#fbeaea;
  --orange:#9a7020;--orange-l:#faf3e0;--blue:#3a6a8a;--blue-l:#e8f0f7;
  --purple:#6a5a8a;--purple-l:#f0ecf5;
  --sh-s:0 1px 3px rgba(44,36,24,.05);--sh-m:0 4px 16px rgba(44,36,24,.08);--sh-l:0 8px 32px rgba(44,36,24,.12);
  --r:10px;--rs:6px;--rl:14px;
  --mgr:#6a5a8a;--mgr-l:#f0ecf5;--staff:#3a6a8a;--staff-l:#e8f0f7;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans Thai',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* ===== LOGIN ===== */
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#2c2418 0%,#4a3d2e 50%,#6b5b45 100%);position:fixed;inset:0;z-index:9999}
#login-screen.hidden{display:none}
.login-card{background:var(--surface);border-radius:20px;padding:48px 40px;width:420px;box-shadow:var(--sh-l);text-align:center}
.login-logo{width:72px;height:72px;background:var(--accent);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;font-weight:700;color:white}
.login-title{font-size:22px;font-weight:700;margin-bottom:4px}
.login-sub{font-size:13px;color:var(--text-s);margin-bottom:32px}
.pin-dots{display:flex;gap:12px;justify-content:center;margin:24px 0 8px}
.pin-dot{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);transition:all .2s}
.pin-dot.filled{background:var(--accent);border-color:var(--accent)}
.pin-dot.wrong{background:var(--red);border-color:var(--red);animation:shake .4s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:280px;margin:24px auto 0}
.pin-btn{width:72px;height:72px;border-radius:50%;border:2px solid var(--border);background:var(--surface);font-family:inherit;font-size:28px;font-weight:600;cursor:pointer;transition:all .15s;justify-self:center;color:var(--text)}
.pin-btn:hover{background:var(--accent-l);border-color:var(--accent)}
.pin-btn:active{transform:scale(.95)}
.pin-btn.clear{font-size:14px;border:none;color:var(--text-s)}
.pin-btn.backspace{font-size:20px;border:none;color:var(--text-s)}
.login-role{display:flex;gap:8px;justify-content:center;margin-bottom:24px}
.role-choice{padding:12px 24px;border:2px solid var(--border);border-radius:var(--r);cursor:pointer;font-family:inherit;font-size:14px;font-weight:500;background:var(--surface);transition:all .15s;display:flex;align-items:center;gap:8px}
.role-choice:hover{border-color:var(--accent)}
.role-choice.sel-mgr{border-color:var(--mgr);background:var(--mgr-l);color:var(--mgr)}
.role-choice.sel-staff{border-color:var(--staff);background:var(--staff-l);color:var(--staff)}
.login-hint{font-size:12px;color:var(--text-m);margin-top:4px}
.login-err{color:var(--red);font-size:13px;min-height:20px;margin-top:8px;font-weight:500}

/* ===== LAYOUT ===== */
.app{display:flex;min-height:100vh}
.sidebar{width:260px;background:var(--text);color:white;position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;overflow-y:auto}
.sb-head{padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}
.sb-logo{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.sb-logo-icon{width:42px;height:42px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
.sb-logo-text{font-size:15px;font-weight:600;line-height:1.3}
.sb-logo-sub{font-size:11px;opacity:.5}
.sb-role{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;margin-top:8px}
.sb-role-mgr{background:var(--mgr);color:white}
.sb-role-staff{background:var(--staff);color:white}
.nav-sec{padding:16px 12px 6px;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.3);font-weight:600}
.nav-i{display:flex;align-items:center;gap:12px;padding:11px 16px;margin:2px 8px;border-radius:var(--rs);color:rgba(255,255,255,.6);cursor:pointer;transition:all .15s;font-size:13px;border:none;background:none;width:calc(100% - 16px);text-align:left;font-family:inherit}
.nav-i:hover{background:rgba(255,255,255,.08);color:rgba(255,255,255,.9)}
.nav-i.active{background:rgba(255,255,255,.12);color:white;font-weight:500}
.nav-icon{font-size:18px;width:24px;text-align:center}
.nav-badge{margin-left:auto;background:var(--red);color:white;font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;min-width:20px;text-align:center}
.nav-badge-o{background:var(--orange)}
.sb-foot{margin-top:auto;padding:16px;border-top:1px solid rgba(255,255,255,.1)}
.sb-logout{display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;border:1px solid rgba(255,255,255,.15);border-radius:var(--rs);background:none;color:rgba(255,255,255,.6);font-size:13px;cursor:pointer;font-family:inherit;transition:all .15s}
.sb-logout:hover{background:rgba(255,255,255,.08);color:white}

.main-area{flex:1;margin-left:260px;min-height:100vh}
.top-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.pg-title{font-size:20px;font-weight:700;letter-spacing:-.3px}
.pg-desc{font-size:12px;color:var(--text-s);margin-top:2px}
.role-tag{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600}
.role-tag-mgr{background:var(--mgr-l);color:var(--mgr)}
.role-tag-staff{background:var(--staff-l);color:var(--staff)}
.content{padding:28px 32px;max-width:1300px}

/* Pages */
.page{display:none;animation:fadeUp .25s ease}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Components */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);box-shadow:var(--sh-s)}
.card-body{padding:24px}
.card-head{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-t{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}

.btn{padding:9px 18px;border:none;border-radius:var(--rs);font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:7px;white-space:nowrap}
.btn-p{background:var(--accent);color:white}.btn-p:hover{background:var(--accent-h)}
.btn-g{background:var(--green);color:white}.btn-g:hover{opacity:.9}
.btn-mgr{background:var(--mgr);color:white}
.btn-o{background:var(--surface);color:var(--text);border:1px solid var(--border)}.btn-o:hover{border-color:var(--accent)}
.btn-ghost{background:transparent;color:var(--text-s)}.btn-ghost:hover{color:var(--text);background:var(--accent-l)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-lg{padding:14px 28px;font-size:16px}
.btn-danger{background:var(--red);color:white}.btn-danger:hover{opacity:.9}

/* Table */
.tbl-w{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{background:var(--surface-alt);padding:10px 14px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px;color:var(--text-s);border-bottom:1px solid var(--border);white-space:nowrap}
tbody td{padding:11px 14px;border-bottom:1px solid var(--border)}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover{background:var(--accent-l)}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
.text-r{text-align:right}

.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:500}
.b-green{background:var(--green-l);color:var(--green)}.b-red{background:var(--red-l);color:var(--red)}
.b-orange{background:var(--orange-l);color:var(--orange)}.b-blue{background:var(--blue-l);color:var(--blue)}
.b-purple{background:var(--purple-l);color:var(--purple)}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;box-shadow:var(--sh-s)}
.stat-label{font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:.4px;color:var(--text-m);margin-bottom:8px}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700}
.stat-sub{font-size:12px;color:var(--text-s);margin-top:4px}

/* Form (LARGER for manager) */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.full{grid-column:1/-1}
.form-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text-s)}
.form-input,.form-select{padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);font-family:inherit;font-size:13px;background:var(--surface);color:var(--text);outline:none;transition:border-color .15s}
.form-input:focus,.form-select:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--text-m)}

/* LARGE form for manager entry */
.mgr-form .form-label{font-size:14px;font-weight:700;letter-spacing:0;text-transform:none;color:var(--text)}
.mgr-form .form-input,.mgr-form .form-select{padding:14px 16px;font-size:18px;border-radius:var(--r);border-width:2px}
.mgr-form .form-input:focus,.mgr-form .form-select:focus{border-color:var(--mgr);box-shadow:0 0 0 3px rgba(106,90,138,.15)}

/* Large service rows for manager */
.svc-row-lg{display:flex;align-items:center;gap:16px;padding:16px 20px;border:2px solid var(--border);border-radius:var(--r);margin-bottom:10px;transition:all .15s;min-height:64px}
.svc-row-lg:hover{border-color:var(--accent)}
.svc-row-lg.has-val{border-color:var(--green);background:var(--green-l)}
.svc-name-lg{font-size:17px;font-weight:600;min-width:140px}
.svc-type-tag{font-size:11px;padding:3px 10px;border-radius:10px;background:var(--surface-alt);color:var(--text-m);border:1px solid var(--border)}
.svc-ref-lg{font-size:14px;color:var(--text-s);font-family:'JetBrains Mono',monospace}
.svc-ref-btn-lg{font-size:13px;color:var(--blue);background:var(--blue-l);border:none;padding:6px 14px;border-radius:var(--rs);cursor:pointer;font-family:inherit;font-weight:500}
.svc-ref-btn-lg:hover{opacity:.8}
.svc-prev{font-size:12px;color:var(--blue);background:var(--blue-l);padding:4px 12px;border-radius:var(--rs);margin-right:8px;white-space:nowrap;cursor:pointer;border:1px solid transparent;transition:all .15s}
.svc-prev:hover{border-color:var(--blue);opacity:.9}
.svc-input-lg{width:160px;padding:12px 14px;border:2px solid var(--border);border-radius:var(--r);font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600;text-align:right;outline:none;background:white}
.svc-input-lg:focus{border-color:var(--mgr);box-shadow:0 0 0 3px rgba(106,90,138,.15)}

/* Customer search for manager - LARGE */
.search-lg{position:relative;margin-bottom:20px}
.search-lg input{width:100%;padding:16px 20px 16px 50px;border:2px solid var(--border);border-radius:var(--r);font-family:inherit;font-size:18px;outline:none;transition:all .15s}
.search-lg input:focus{border-color:var(--mgr);box-shadow:0 0 0 3px rgba(106,90,138,.15)}
.search-lg-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:22px;color:var(--text-m)}
.search-lg-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:2px solid var(--mgr);border-top:none;border-radius:0 0 var(--r) var(--r);box-shadow:var(--sh-m);z-index:10;display:none}
.search-lg-results.show{display:block}
.search-result-item{padding:14px 20px;cursor:pointer;font-size:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.search-result-item:hover{background:var(--accent-l)}
.search-result-item:last-child{border-bottom:none}
.search-result-code{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--text-s);min-width:80px}

/* Modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(44,36,24,.45);backdrop-filter:blur(4px);z-index:300;justify-content:center;align-items:center}
.modal-bg.show{display:flex}
.modal{background:var(--surface);border-radius:var(--rl);max-width:700px;width:92%;max-height:90vh;overflow-y:auto;box-shadow:var(--sh-l)}
.modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:17px;font-weight:700}
.modal-body{padding:24px}
.modal-foot{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}

/* Image viewer */
.img-viewer{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:400;justify-content:center;align-items:center;cursor:pointer}
.img-viewer.show{display:flex}
.img-viewer img{max-width:90%;max-height:90vh;border-radius:var(--r);box-shadow:0 0 40px rgba(0,0,0,.5)}

/* Invoice Preview */
.inv-preview{background:white;border:2px solid var(--border);border-radius:var(--rl);padding:40px;max-width:750px;margin:0 auto;box-shadow:var(--sh-l)}
.inv-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:20px;border-bottom:2px solid var(--text)}
.inv-title{font-size:26px;font-weight:700;letter-spacing:-.5px}
.inv-no{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-s);margin-top:4px}
.inv-ml{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-m);font-weight:600}
.inv-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px}
.inv-table{width:100%;margin-bottom:20px}
.inv-table th{padding:8px 0;border-bottom:2px solid var(--text);font-size:11px;text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.inv-table td{padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.inv-total-box{background:var(--text);color:white;padding:16px 24px;border-radius:var(--rs);text-align:right;min-width:220px}

/* QR + Signature area */
.inv-footer{margin-top:28px;border-top:2px solid var(--border);padding-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:24px}
.qr-section{text-align:center}
.qr-placeholder{width:140px;height:140px;background:var(--surface-alt);border:2px dashed var(--border);border-radius:var(--r);display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 8px;font-size:12px;color:var(--text-m)}
.sign-section{border:2px solid var(--border);border-radius:var(--r);padding:20px}
.sign-line{border-bottom:1px dashed var(--text-m);height:50px;margin:8px 0}
.sign-label{font-size:11px;color:var(--text-m);text-align:center}
.pay-check{display:flex;gap:16px;margin-top:12px}
.pay-check-item{display:flex;align-items:center;gap:6px;font-size:12px}
.pay-check-box{width:16px;height:16px;border:2px solid var(--text);border-radius:3px}

/* Receipt */
.receipt-preview{background:white;border:2px solid var(--border);border-radius:var(--rl);padding:40px;max-width:750px;margin:0 auto;box-shadow:var(--sh-l)}
.receipt-stamp{display:inline-flex;padding:8px 20px;border:3px solid var(--green);border-radius:var(--rs);color:var(--green);font-size:14px;font-weight:700;transform:rotate(-5deg);margin-top:8px}

/* Approval */
.approval-card{border:2px solid var(--border);border-radius:var(--r);padding:16px 20px;margin-bottom:12px;transition:all .15s}
.approval-card:hover{border-color:var(--accent);box-shadow:var(--sh-s)}
.approval-card.pending{border-left:4px solid var(--orange)}
.approval-card.approved{border-left:4px solid var(--green)}
.approval-img{width:120px;height:80px;object-fit:cover;border-radius:var(--rs);border:1px solid var(--border);cursor:pointer;transition:transform .15s}
.approval-img:hover{transform:scale(1.05)}

/* Inner tabs */
.in-tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);padding:0 24px}
.in-tab{padding:12px 16px;font-size:13px;font-weight:500;color:var(--text-s);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;font-family:inherit;transition:all .15s}
.in-tab:hover{color:var(--text)}.in-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rpt-mode-btn{background:var(--surface);border:1px solid var(--border);color:var(--text-m);font-size:12px !important;padding:4px 12px !important;border-radius:20px !important;cursor:pointer}
.rpt-mode-btn.active{background:var(--accent);color:white;border-color:var(--accent)}

/* Highlight box */
.hb{padding:14px 18px;border-radius:var(--rs);border:1px solid}
.hb-green{border-color:rgba(74,122,82,.2);background:var(--green-l)}
.hb-orange{border-color:rgba(154,112,32,.2);background:var(--orange-l)}
.hb-purple{border-color:rgba(106,90,138,.2);background:var(--purple-l)}

/* Flow */
.flow{display:flex;align-items:center;gap:0;margin-bottom:24px;flex-wrap:wrap}
.flow-s{display:flex;align-items:center;gap:7px;padding:7px 14px;border-radius:20px;font-size:12px;font-weight:500;color:var(--text-m)}
.flow-s.active{background:var(--accent);color:white}
.flow-s.done{background:var(--green-l);color:var(--green)}
.flow-num{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid currentColor}
.flow-s.active .flow-num{background:white;color:var(--accent);border-color:white}
.flow-s.done .flow-num{background:var(--green);color:white;border-color:var(--green)}
.flow-arr{width:28px;text-align:center;color:var(--text-m);font-size:14px}

/* Payment option */
.pay-opt{padding:12px;border:2px solid var(--border);border-radius:var(--rs);text-align:center;cursor:pointer;transition:all .15s}
.pay-opt:hover{border-color:var(--accent)}.pay-opt.sel{border-color:var(--accent);background:var(--accent-l)}

/* Invoice customer row hover */
.inv-cust-row{transition:all .15s}
.inv-cust-row:hover{background:var(--purple-l) !important;cursor:pointer}
/* Payment item selection (collect page) */
.pay-item{display:flex;align-items:center;padding:12px 20px;border-bottom:1px solid var(--border);cursor:pointer;gap:12px}
.pay-item:hover{background:var(--accent-l)}
.pay-item.sel{background:var(--green-l)}
.pay-item.sel .pay-check{background:var(--green);border-color:var(--green);color:white}
.pay-item.sel .pay-check::after{content:'‚úì'}
.pay-item:not(.sel) .pay-check::after{content:''}
.pay-item:not(.sel){opacity:.6}
.pay-item:not(.sel) .pay-item-amt{text-decoration:line-through;color:var(--text-m) !important}
.pay-item-chk{flex-shrink:0}
.pi-cb{width:22px;height:22px;border:2px solid var(--border);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:transparent;transition:all .15s}
.pi-cb.checked{background:var(--green);border-color:var(--green);color:white}
.pay-item-info{flex:1}
.pay-item-name{font-weight:600;font-size:14px}
.pay-item-month{font-size:11px;color:var(--text-s)}
.pay-item-amt{font-weight:700;font-size:16px;color:var(--text)}

/* Payment channel blocks */
.pay-channel{padding:20px;border-bottom:2px solid var(--border);position:relative}
.pay-channel:last-of-type{border-bottom:none}
.pay-ch-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.pay-amt-input{border:2px solid var(--accent) !important;background:var(--accent-l) !important}

/* Helpers */
.flex{display:flex}.flex-col{flex-direction:column}.items-c{align-items:center}.jc-b{justify-content:space-between}
.gap-8{gap:8px}.gap-12{gap:12px}.gap-16{gap:16px}.gap-24{gap:24px}
.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-24{margin-top:24px}
.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}.mb-24{margin-bottom:24px}

@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}.main-area{margin-left:0}
  .stats{grid-template-columns:repeat(2,1fr)}.form-grid,.form-grid-3{grid-template-columns:1fr}
  .content{padding:16px}.inv-grid{grid-template-columns:1fr}.inv-footer{grid-template-columns:1fr}
}
@media(max-width:1100px){
  .collect-grid{grid-template-columns:1fr !important}
}

/* Print styles */
@media print {
  body { background: white !important; }
  .sidebar, .top-bar, .flow, .hb, #inv-step-select, #inv-step-list,
  .btn, .nav-i, .sb-foot, .role-tag, .pg-desc,
  [onclick*="backToInvList"], [onclick*="goPage"], [onclick*="window.print"] { display: none !important; }
  .main-area { margin-left: 0 !important; }
  .content { padding: 0 !important; max-width: 100% !important; }
  #inv-step-print { display: block !important; }
  .inv-preview, .receipt-preview { box-shadow: none !important; border: none !important; padding: 20px !important; }
  .page { display: none !important; }
  .page.active { display: block !important; }
  .pg-title { display: none !important; }
}
</style>
</head>
<body>

<!-- ============================= LOGIN SCREEN ============================= -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">‡∏ô‡∏ó</div>
    <div class="login-title">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
    <div class="login-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>

    <div class="login-role">
      <div class="role-choice sel-mgr" id="rc-mgr" onclick="selectLoginRole('mgr')">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
      <div class="role-choice" id="rc-staff" onclick="selectLoginRole('staff')">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
    </div>

    <div style="font-size:14px;color:var(--text-s);margin-bottom:4px" id="pin-label">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å</div>
    <div class="pin-dots" id="pin-dots"></div>
    <div class="login-err" id="pin-err"></div>

    <div class="pin-pad" id="pin-pad">
      <button class="pin-btn" onclick="pinInput('1')">1</button>
      <button class="pin-btn" onclick="pinInput('2')">2</button>
      <button class="pin-btn" onclick="pinInput('3')">3</button>
      <button class="pin-btn" onclick="pinInput('4')">4</button>
      <button class="pin-btn" onclick="pinInput('5')">5</button>
      <button class="pin-btn" onclick="pinInput('6')">6</button>
      <button class="pin-btn" onclick="pinInput('7')">7</button>
      <button class="pin-btn" onclick="pinInput('8')">8</button>
      <button class="pin-btn" onclick="pinInput('9')">9</button>
      <button class="pin-btn clear" onclick="pinClear()">‡∏•‡πâ‡∏≤‡∏á</button>
      <button class="pin-btn" onclick="pinInput('0')">0</button>
      <button class="pin-btn backspace" onclick="pinBack()">‚å´</button>
    </div>
    <div class="login-hint mt-12" id="pin-hint">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: 5 ‡∏´‡∏•‡∏±‡∏Å ¬∑ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: 4 ‡∏´‡∏•‡∏±‡∏Å</div>
  </div>
</div>

<!-- ============================= APP ============================= -->
<div class="app" id="app" style="display:none">

<!-- ===== SIDEBAR ===== -->
<div class="sidebar" id="sidebar">
  <div class="sb-head">
    <div class="sb-logo">
      <div class="sb-logo-icon">‡∏ô‡∏ó</div>
      <div>
        <div class="sb-logo-text">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
        <div class="sb-logo-sub">Numsub Accounting</div>
      </div>
    </div>
    <div class="sb-role sb-role-mgr" id="sb-role-badge">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
  </div>

  <!-- Manager Nav -->
  <div id="nav-mgr">
    <div class="nav-sec">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <button class="nav-i active" onclick="goPage('mgr-dash')"><span class="nav-icon">üìä</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <button class="nav-i" onclick="goPage('mgr-cust')"><span class="nav-icon">üë•</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    <button class="nav-i" onclick="goPage('mgr-entry')"><span class="nav-icon">‚úèÔ∏è</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
    <div class="nav-sec">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
    <button class="nav-i" onclick="goPage('mgr-approve')"><span class="nav-icon">‚úÖ</span>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô<span class="nav-badge" id="nav-approve-count" style="display:none">0</span></button>
    <div class="nav-sec">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
    <button class="nav-i" onclick="goPage('mgr-report')"><span class="nav-icon">üìã</span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
  </div>

  <!-- Staff Nav -->
  <div id="nav-staff" style="display:none">
    <div class="nav-sec">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <button class="nav-i active" onclick="goPage('staff-dash')"><span class="nav-icon">üìä</span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
    <button class="nav-i" onclick="goPage('staff-cust')"><span class="nav-icon">üë•</span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    <div class="nav-sec">‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</div>
    <button class="nav-i" onclick="goPage('staff-inv')"><span class="nav-icon">üìÑ</span>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
    <button class="nav-i" onclick="goToCollect()"><span class="nav-icon">üí∞</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</button>
    <button class="nav-i" onclick="goPage('staff-submit')"><span class="nav-icon">üì§</span>‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô/‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<span class="nav-badge nav-badge-o" id="nav-submit-count" style="display:none">0</span></button>
    <div class="nav-sec">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
    <button class="nav-i" onclick="goPage('staff-report')"><span class="nav-icon">üìã</span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
    <button class="nav-i" onclick="goPage('staff-history')"><span class="nav-icon">üïê</span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
  </div>

  <div class="sb-foot">
    <button class="sb-logout" id="btn-refresh" onclick="refreshData()" style="margin-bottom:8px;border-color:rgba(255,255,255,.25);color:rgba(255,255,255,.8)">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <button class="sb-logout" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</div>

<!-- ===== MAIN ===== -->
<div class="main-area">

<!-- ============ MGR: DASHBOARD ============ -->
<div class="page active" id="page-mgr-dash">
  <div class="top-bar"><div><div class="pg-title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div><div class="pg-desc" id="mgr-dash-month">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div></div><div class="role-tag role-tag-mgr">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div></div>
  <div class="content">
    <div class="stats" id="mgr-stats">
      <div class="stat"><div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-val" id="mgr-s-cust">‚Äî</div><div class="stat-sub">‡∏£‡∏≤‡∏¢</div></div>
      <div class="stat"><div class="stat-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-val" style="color:var(--blue)" id="mgr-s-billed">‚Äî</div><div class="stat-sub" id="mgr-s-billed-sub"></div></div>
      <div class="stat"><div class="stat-label">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</div><div class="stat-val" style="color:var(--green)" id="mgr-s-paid">‚Äî</div><div class="stat-sub" id="mgr-s-paid-pct"></div></div>
      <div class="stat"><div class="stat-label">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="stat-val" style="color:var(--orange)" id="mgr-s-pending">‚Äî</div><div class="stat-sub" id="mgr-s-pending-sub"></div></div>
    </div>
    <div class="flex gap-24">
      <div class="card" style="flex:1"><div class="card-head"><div class="card-t">üî¥ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div></div><div class="tbl-w"><table><thead><tr><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</th><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th></tr></thead><tbody id="mgr-outstanding-tb">
        <tr><td colspan="3" style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
      </tbody></table></div></div>
      <div class="card" style="flex:1"><div class="card-head"><div class="card-t">‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><button class="btn btn-sm btn-mgr" onclick="goPage('mgr-approve')">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</button></div><div class="card-body" id="mgr-pending-list">
        <div style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      </div></div>
    </div>
  </div>
</div>

<!-- ============ MGR: CUSTOMERS ============ -->
<div class="page" id="page-mgr-cust">
  <div class="top-bar"><div><div class="pg-title">üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="pg-desc">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div></div><button class="btn btn-p" onclick="openModal('add-cust')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button></div>
  <div class="content">
    <div class="search-lg"><span class="search-lg-icon">üîç</span><input placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." oninput="filterCustTable(this.value,'mgr-cust-tb')" /></div>
    <div class="card"><div class="tbl-w"><table><thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th><th class="text-r">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th><th></th></tr></thead>
    <tbody id="mgr-cust-tb">
      <tr><td colspan="7" style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody></table></div></div>
  </div>
</div>

<!-- ============ MGR: ENTRY (LARGE UI) ============ -->
<div class="page" id="page-mgr-entry">
  <div class="top-bar"><div><div class="pg-title">‚úèÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div class="pg-desc">‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏µ/‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤+‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div></div><div class="role-tag role-tag-mgr">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div></div>
  <div class="content mgr-form">

    <!-- Large month/date selection -->
    <div class="card mb-24"><div class="card-body">
      <div class="form-grid" style="grid-template-columns:1fr 1fr">
        <div class="form-group"><label class="form-label">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label><select class="form-select" id="entry-month" onchange="onEntryMonthChange()"><option value="" selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select></div>
        <div class="form-group"><label class="form-label">üìÜ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</label><input type="date" class="form-input" id="entry-calc-date" /></div>
      </div>
    </div></div>

    <!-- Customer search LARGE -->
    <div class="form-group mb-16">
      <label class="form-label" style="font-size:16px">üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
    </div>
    <div class="search-lg">
      <span class="search-lg-icon">üë§</span>
      <input placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="mgr-cust-search" oninput="filterEntrySearch(this.value)" onfocus="document.getElementById('search-results').classList.add('show')" onblur="setTimeout(()=>document.getElementById('search-results').classList.remove('show'),200)" />
      <div class="search-lg-results" id="search-results">
        <div style="padding:14px 20px;color:var(--text-m);text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...</div>
      </div>
    </div>

    <!-- Entry area: appears after selecting customer -->
    <div id="entry-area" style="display:none">

      <!-- Selected customer info -->
      <div class="hb hb-purple mb-16 flex items-c jc-b" id="selected-cust-info">
        <div class="flex items-c gap-16">
          <span style="font-size:32px">üë§</span>
          <div>
            <div style="font-weight:700;font-size:20px" id="sel-cust-name">‚Äî</div>
            <div style="font-size:14px;color:var(--text-s)" id="sel-cust-sub">‚Äî</div>
          </div>
        </div>
        <button class="btn btn-o btn-sm" onclick="resetEntryArea()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      </div>

      <!-- ===== BANNER: ‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô (shown when has-prev) ===== -->
      <div id="prev-month-banner" style="display:none;background:linear-gradient(135deg,var(--blue-l),var(--green-l));border:2px solid var(--green);border-radius:var(--rl);padding:20px 24px;margin-bottom:20px">
        <div class="flex items-c jc-b" style="margin-bottom:12px">
          <div>
            <div style="font-weight:700;font-size:16px;color:var(--green)">üìã ‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô (<span id="prev-month-label">‚Äî</span>)</div>
            <div style="font-size:13px;color:var(--text-s);margin-top:4px">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</div>
          </div>
          <div style="text-align:right">
            <div class="mono" style="font-size:26px;font-weight:700;color:var(--green)" id="prev-month-total">‚Äî</div>
            <div style="font-size:11px;color:var(--text-s)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>
          </div>
        </div>
        <div class="flex gap-8">
          <button class="btn btn-g btn-lg" style="flex:1" onclick="fillAllPrev()">‚úÖ ‡∏Ñ‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          <button class="btn btn-o btn-lg" onclick="document.getElementById('prev-month-banner').style.display='none'">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</button>
        </div>
      </div>

      <!-- ===== BANNER: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (shown when no-prev) ===== -->
      <div id="new-cust-banner" style="display:none;background:var(--surface-alt);border:2px dashed var(--border);border-radius:var(--rl);padding:20px 24px;margin-bottom:20px;text-align:center">
        <div style="font-size:28px;margin-bottom:8px">üÜï</div>
        <div style="font-weight:700;font-size:15px;color:var(--text-s)">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</div>
        <div style="font-size:13px;color:var(--text-m);margin-top:4px">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà ‚Äî ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>

      <!-- Service inputs -->
      <div class="card"><div class="card-head"><div class="card-t" style="font-size:18px">üìù ‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î ‚Äî <span id="entry-month-title">‚Äî</span></div><div id="entry-svc-actions"><button class="btn btn-sm btn-o" onclick="clearAllSvc()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div></div><div class="card-body">
        <div style="font-size:15px;font-weight:700;color:var(--text-s);margin-bottom:16px">üìÖ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>

        <div class="svc-row-lg" data-svc="accounting"><div class="svc-name-lg">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="vat"><div class="svc-name-lg">‡∏†‡∏û 30</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="wht"><div class="svc-name-lg">‡∏†‡∏á‡∏î 3,53</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="sbt"><div class="svc-name-lg">‡∏†‡∏ò 40</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="pnd90"><div class="svc-name-lg">‡∏†‡∏á‡∏î 90</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="pnd94"><div class="svc-name-lg">‡∏†‡∏á‡∏î 94</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div style="flex:1"></div><div class="svc-prev" style="display:none"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="other"><div class="svc-name-lg">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><input class="form-input" style="flex:1;font-size:16px;padding:10px 14px" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." /><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>

        <div style="font-size:15px;font-weight:700;color:var(--text-s);margin:24px 0 16px">üìÜ ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div>
        <div class="svc-row-lg" data-svc="audit"><div class="svc-name-lg">‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ö ‡∏ö‡∏ä</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div><div style="flex:1"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="pnd51"><div class="svc-name-lg">‡∏†‡∏á‡∏î 51</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div><div style="flex:1"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>
        <div class="svc-row-lg" data-svc="pnd50"><div class="svc-name-lg">‡∏†‡∏á‡∏î 50</div><div class="svc-type-tag">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</div><div style="flex:1"></div><input class="svc-input-lg" placeholder="0" inputmode="numeric" oninput="updateEntryTotal()" /></div>

        <!-- Total LARGE -->
        <div style="margin-top:24px;padding:24px;background:var(--surface-alt);border-radius:var(--r);border:2px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-size:16px;color:var(--text-s)">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° <span id="entry-total-label">‚Äî</span></div><div style="font-size:13px;color:var(--text-m);margin-top:4px" id="entry-item-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
          <div class="mono" style="font-size:36px;font-weight:700;color:var(--accent)" id="entry-total-val">‡∏ø0</div>
        </div>

        <div class="flex mt-24" style="justify-content:flex-end;gap:12px">
          <button class="btn btn-o btn-lg" onclick="resetEntryArea()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-p btn-lg" onclick="saveEntry()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î</button>
        </div>
      </div></div>
    </div><!-- /entry-area -->

  </div>
</div>

<!-- ============ MGR: APPROVE ============ -->
<div class="page" id="page-mgr-approve">
  <div class="top-bar"><div><div class="pg-title">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô</div><div class="pg-desc">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div><div class="role-tag role-tag-mgr">üëî ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div></div>
  <div class="content">
    <div class="in-tabs mb-24"><button class="in-tab active" onclick="switchInTab(this,'approve-pending')">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button class="in-tab" onclick="switchInTab(this,'approve-done')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button><button class="in-tab" onclick="switchInTab(this,'approve-reject')">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div>

    <div id="approve-pending">
      <div id="approve-pending-list" style="text-align:center;padding:24px;color:var(--text-m)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div><!-- /approve-pending -->

    <div id="approve-done" style="display:none">
      <div id="approve-done-list" style="text-align:center;padding:24px;color:var(--text-m)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <div id="approve-reject" style="display:none">
      <div style="text-align:center;padding:40px;color:var(--text-m)">
        <div style="font-size:32px;margin-bottom:12px">üì≠</div>
        <div style="font-size:14px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
      </div>
    </div>

  </div>
</div>

<!-- ============ MGR: REPORT ============ -->
<div class="page" id="page-mgr-report">
  <div class="top-bar"><div><div class="pg-title">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</div><div class="pg-desc">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</div></div><div class="flex gap-8"><button class="btn btn-p btn-sm" onclick="exportReportPDF('mgr')">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button></div></div>
  <div class="content" id="report-area-mgr"></div>
</div>

<!-- ============ STAFF: DASHBOARD ============ -->
<div class="page" id="page-staff-dash">
  <div class="top-bar"><div><div class="pg-title">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div><div class="pg-desc" id="staff-dash-desc">‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</div></div><div class="role-tag role-tag-staff" id="staff-role-name">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></div>
  <div class="content">
    <div class="stats" id="staff-stats">
      <div class="stat"><div class="stat-label">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div><div class="stat-val" style="color:var(--blue)" id="stf-s-inv">‚Äî</div><div class="stat-sub">‡πÉ‡∏ö</div></div>
      <div class="stat"><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div><div class="stat-val" style="color:var(--orange)" id="stf-s-wait">‚Äî</div></div>
      <div class="stat"><div class="stat-label">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</div><div class="stat-val" style="color:var(--green)" id="stf-s-done">‚Äî</div></div>
      <div class="stat"><div class="stat-label">‡∏£‡∏≠‡∏ú‡∏à‡∏Å.‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="stat-val" style="color:var(--orange)" id="stf-s-pend">‚Äî</div></div>
    </div>
    <div class="card"><div class="card-head"><div class="card-t">üìÑ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div></div><div class="tbl-w"><table><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th></th></tr></thead>
    <tbody id="staff-inv-tb">
      <tr><td colspan="6" style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody></table></div></div>
  </div>
</div>

<!-- ============ STAFF: CUSTOMERS (read + add only) ============ -->
<div class="page" id="page-staff-cust">
  <div class="top-bar"><div><div class="pg-title">üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="pg-desc">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div></div><button class="btn btn-p" onclick="openModal('add-cust')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button></div>
  <div class="content">
    <div class="hb hb-orange mb-16 flex items-c gap-8" style="font-size:13px;color:var(--orange)">‚ö†Ô∏è ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <strong>‡πÄ‡∏û‡∏¥‡πà‡∏°</strong> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)</div>
    <div class="search-lg mb-16"><span class="search-lg-icon">üîç</span><input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." oninput="filterCustTable(this.value,'staff-cust-tb')" /></div>
    <div class="card"><div class="tbl-w"><table><thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th><th class="text-r">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th></tr></thead>
    <tbody id="staff-cust-tb">
      <tr><td colspan="6" style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
    </tbody></table></div></div>
  </div>
</div>

<!-- ============ STAFF: INVOICE ============ -->
<div class="page" id="page-staff-inv">
  <div class="top-bar"><div><div class="pg-title">üìÑ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div><div class="pg-desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‚Üí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div></div><div class="role-tag role-tag-staff">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></div>
  <div class="content">
    <div class="flow mb-24"><div class="flow-s active" id="inv-flow-1"><div class="flow-num">1</div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div class="flow-arr">‚Üí</div><div class="flow-s" id="inv-flow-2"><div class="flow-num">2</div>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</div><div class="flow-arr">‚Üí</div><div class="flow-s" id="inv-flow-3"><div class="flow-num">3</div>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div></div>

    <!-- Step 1: Customer Selection -->
    <div id="inv-step-select">
      <div class="card mb-24">
        <div class="card-head"><div class="card-t" style="font-size:17px">üë§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div></div>
        <div class="card-body">
          <div class="search-lg" style="margin-bottom:0">
            <span class="search-lg-icon">üîç</span>
            <input placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." id="inv-cust-search" oninput="filterInvCust(this.value)" onfocus="document.getElementById('inv-cust-list').style.display='block'" />
          </div>
        </div>
      </div>

      <!-- Customer list -->
      <div id="inv-cust-list">
        <div class="card">
          <div class="tbl-w">
            <table id="inv-cust-table">
              <thead><tr><th style="width:40px"></th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
              <tbody id="inv-cust-tbody"><tr><td colspan="6" style="text-align:center;color:var(--text-m);padding:24px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...</td></tr></tbody>
            </table>
          </div>
        </div>
        <div style="text-align:center;margin-top:16px;font-size:13px;color:var(--text-m)">üëÜ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
      </div>
    </div>

    <!-- Step 2: ALL unpaid items (no selection - mandatory all) -->
    <div id="inv-step-list" style="display:none">
      <div class="hb hb-purple mb-24 flex items-c jc-b">
        <div class="flex items-c gap-12">
          <span style="font-size:24px">üë§</span>
          <div>
            <div style="font-weight:700;font-size:17px" id="inv-sel-name">‚Äî</div>
            <div style="font-size:13px;color:var(--text-s)" id="inv-sel-info">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
        </div>
        <button class="btn btn-o" onclick="backToInvSelect()">‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      </div>

      <div class="card mb-24">
        <div class="card-head"><div class="card-t" style="font-size:16px">üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
        <div class="tbl-w">
          <table>
            <thead><tr><th>#</th><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
            <tbody id="inv-detail-tbody">
              <tr><td colspan="4" style="text-align:center;color:var(--text-m);padding:24px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td></tr>
            </tbody>
            <tfoot><tr style="background:var(--surface-alt);font-weight:700"><td colspan="3" style="font-size:15px;padding:14px">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td><td class="text-r mono" style="font-size:20px;color:var(--accent)" id="inv-list-total">‚Äî</td></tr></tfoot>
          </table>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn btn-o btn-lg" onclick="backToInvSelect()">‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
        <button class="btn btn-p btn-lg" onclick="generateInvPreview()">üìÑ ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á / ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
        <button class="btn btn-g btn-lg" onclick="goToCollect()">üí∞ ‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Invoice Print Preview -->
    <div id="inv-step-print" style="display:none">
      <div class="flex items-c jc-b mb-24">
        <button class="btn btn-o" onclick="backToInvList()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <div class="flex gap-8">
          <button class="btn btn-p btn-lg" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
          <button class="btn btn-g" onclick="goToCollect()">üí∞ ‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ ‚Üí</button>
        </div>
      </div>

      <div class="inv-preview" id="inv-print-area">
        <div class="inv-head">
          <div><div class="inv-title">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div><div class="inv-no" id="inv-print-no">‚Äî</div><div style="font-size:12px;margin-top:4px;color:var(--text-s)">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div></div>
          <div style="text-align:right"><div class="inv-ml">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</div><div style="font-weight:600" id="inv-print-date">‚Äî</div><div class="inv-ml" style="margin-top:6px">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞</div><div style="font-weight:600" id="inv-print-due">‚Äî</div></div>
        </div>
        <div class="inv-grid">
          <div><div class="inv-ml">‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ</div><div style="font-weight:600;font-size:15px" id="inv-print-cust">‚Äî</div><div style="font-size:12px;color:var(--text-s)" id="inv-print-code">‚Äî</div></div>
          <div><div class="inv-ml">‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢</div><div style="font-weight:600;font-size:15px">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div></div>
        </div>

        <!-- Dynamic invoice items -->
        <table class="inv-table">
          <thead><tr><th style="text-align:left">#</th><th style="text-align:left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:left">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
          <tbody id="inv-print-body">
            <!-- filled by JS -->
          </tbody>
        </table>
        <div style="display:flex;justify-content:flex-end"><div class="inv-total-box"><div style="font-size:11px;opacity:.7">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</div><div style="font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700" id="inv-print-total">‚Äî</div><div style="font-size:11px;opacity:.7;margin-top:2px" id="inv-print-total-text">‚Äî</div></div></div>

        <!-- QR + Signature Footer -->
        <div class="inv-footer">
          <div class="qr-section">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text-m);margin-bottom:12px">‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡πà‡∏≤‡∏ô QR Code</div>
            <div class="qr-placeholder">
              <div style="font-size:32px;margin-bottom:4px">üì±</div>
              <div>QR Code</div>
              <div style="font-size:10px" id="inv-qr-acct-name">‚Äî</div>
            </div>
            <div style="font-size:11px;color:var(--text-s)" id="inv-bank-info">‚Äî</div>
            <div style="font-size:11px;color:var(--text-s)" id="inv-bank-name">‚Äî</div>
          </div>
          <div class="sign-section">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text-m);margin-bottom:8px">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
            <div class="sign-line"></div>
            <div class="sign-label">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ............................................</div>
            <div class="sign-label" style="margin-top:4px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ......./......./..........</div>
            <div style="margin-top:16px;padding-top:12px;border-top:1px dashed var(--border)">
              <div style="font-size:11px;font-weight:600;color:var(--text-m);margin-bottom:8px">‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
              <div class="pay-check">
                <div class="pay-check-item"><div class="pay-check-box"></div> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
                <div class="pay-check-item"><div class="pay-check-box"></div> ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</div>
                <div class="pay-check-item"><div class="pay-check-box"></div> ‡πÄ‡∏ä‡πá‡∏Ñ</div>
              </div>
              <div style="margin-top:8px;font-size:11px;color:var(--text-m)">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ........................ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ........................</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex mt-24" style="justify-content:center;gap:12px">
        <button class="btn btn-o btn-lg" onclick="backToInvList()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn btn-p btn-lg" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
        <button class="btn btn-g btn-lg" onclick="goToCollect()">üí∞ ‡πÑ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ ‚Üí</button>
      </div>
    </div>

  </div>
</div>

<!-- ============ STAFF: COLLECT ============ -->
<div class="page" id="page-staff-collect">
  <div class="top-bar"><div><div class="pg-title">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div><div class="pg-desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞ ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Üí ‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div><div class="role-tag role-tag-staff">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></div>
  <div class="content">
    <div class="flow mb-24"><div class="flow-s done"><div class="flow-num">‚úì</div>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div><div class="flow-arr">‚Üí</div><div class="flow-s active"><div class="flow-num">2</div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ & ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</div><div class="flow-arr">‚Üí</div><div class="flow-s"><div class="flow-num">3</div>‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div>

    <!-- Customer banner -->
    <div class="hb hb-green mb-24 flex items-c jc-b">
      <div class="flex items-c gap-12"><span style="font-size:20px">üìÑ</span><div><div style="font-weight:700" id="collect-header">‚Äî</div><div style="font-size:12px;color:var(--text-s)" id="collect-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div></div></div>
      <button class="btn btn-o btn-sm" onclick="goPage('staff-inv')">‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    </div>

    <div class="collect-grid" style="display:grid;grid-template-columns:3fr 2fr;gap:24px">

      <!-- LEFT: Item selection + Payment info -->
      <div>
        <!-- Item selection card -->
        <div class="card mb-24">
          <div class="card-head">
            <div class="card-t">‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞</div>
            <div class="flex gap-8">
              <button class="btn btn-sm btn-p" onclick="toggleAllPay(true)">‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              <button class="btn btn-sm btn-o" onclick="toggleAllPay(false)">‚òê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
          </div>
          <div class="card-body" style="padding:0">

            <div id="collect-items-list" style="text-align:center;padding:24px;color:var(--text-m)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</div>

          </div>
        </div>

        <!-- Payment channels card (split payment) -->
        <div class="card">
          <div class="card-head">
            <div class="card-t">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</div>
            <button class="btn btn-sm btn-p" onclick="addPayChannel()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</button>
          </div>
          <div class="card-body" id="pay-channels">

            <!-- Channel 1 -->
            <div class="pay-channel" id="pay-ch-1">
              <div class="pay-ch-head">
                <div style="font-weight:600;font-size:14px">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà 1</div>
                <button class="btn btn-ghost btn-sm" onclick="removePayChannel(1)" style="color:var(--red);display:none" id="pay-ch-1-del">‚úï ‡∏•‡∏ö</button>
              </div>
              <div class="form-group mb-12"><div class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px">
                  <div class="pay-opt sel" onclick="selPayCh(this)"><div style="font-size:18px">üè¶</div><div style="font-size:11px;font-weight:500">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div></div>
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üíµ</div><div style="font-size:11px;font-weight:500">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div></div>
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üìù</div><div style="font-size:11px;font-weight:500">‡πÄ‡∏ä‡πá‡∏Ñ</div></div>
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üîÑ</div><div style="font-size:11px;font-weight:500">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div></div>
                </div>
              </div>
              <div class="form-group mb-12">
                <label class="form-label">üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
                <input class="form-input mono pay-amt-input" placeholder="0.00" inputmode="decimal" style="font-size:20px;font-weight:700;text-align:right;padding:12px 16px" oninput="updatePayTotal()" id="pay-ch-1-amt" />
              </div>
              <div class="pay-bank-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="form-group"><label class="form-label">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><select class="form-select" id="pay-ch-1-bank"><option>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option><option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option><option>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option><option>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option><option>‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option><option>‚Äî</option></select></div>
                <div class="form-group"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á/‡∏™‡∏•‡∏¥‡∏õ</label><input class="form-input mono" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏¥‡∏õ/‡πÄ‡∏ä‡πá‡∏Ñ" id="pay-ch-1-ref" /></div>
              </div>
              <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label><input type="date" class="form-input" id="pay-ch-1-date" /></div>
            </div>

          </div>

          <!-- Hidden template for additional channels -->
          <template id="pay-channel-tpl">
            <div class="pay-channel" id="pay-ch-{N}">
              <div class="pay-ch-head">
                <div style="font-weight:600;font-size:14px">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà {N}</div>
                <button class="btn btn-ghost btn-sm" onclick="removePayChannel({N})" style="color:var(--red)" id="pay-ch-{N}-del">‚úï ‡∏•‡∏ö</button>
              </div>
              <div class="form-group mb-12"><div class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px">
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üè¶</div><div style="font-size:11px;font-weight:500">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div></div>
                  <div class="pay-opt sel" onclick="selPayCh(this)"><div style="font-size:18px">üíµ</div><div style="font-size:11px;font-weight:500">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div></div>
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üìù</div><div style="font-size:11px;font-weight:500">‡πÄ‡∏ä‡πá‡∏Ñ</div></div>
                  <div class="pay-opt" onclick="selPayCh(this)"><div style="font-size:18px">üîÑ</div><div style="font-size:11px;font-weight:500">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div></div>
                </div>
              </div>
              <div class="form-group mb-12">
                <label class="form-label">üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</label>
                <input class="form-input mono pay-amt-input" placeholder="0.00" inputmode="decimal" style="font-size:20px;font-weight:700;text-align:right;padding:12px 16px" oninput="updatePayTotal()" id="pay-ch-{N}-amt" />
              </div>
              <div class="pay-bank-row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="form-group"><label class="form-label">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><select class="form-select" id="pay-ch-{N}-bank"><option>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option><option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option><option>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option><option>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option><option>‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option><option>‚Äî</option></select></div>
                <div class="form-group"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á/‡∏™‡∏•‡∏¥‡∏õ</label><input class="form-input mono" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏•‡∏¥‡∏õ/‡πÄ‡∏ä‡πá‡∏Ñ" id="pay-ch-{N}-ref" /></div>
              </div>
              <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</label><input type="date" class="form-input" id="pay-ch-{N}-date" /></div>
            </div>
          </template>

          <!-- Attachment + Note -->
          <div class="card-body" style="border-top:2px solid var(--border)">
            <div class="form-group mb-16"><label class="form-label">üìé ‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏™‡∏•‡∏¥‡∏õ/‡∏†‡∏≤‡∏û‡πÄ‡∏ä‡πá‡∏Ñ)</label>
              <div style="padding:20px;border:2px dashed var(--border);border-radius:var(--r);text-align:center;color:var(--text-m);font-size:14px;cursor:pointer">üìé ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á<br><span style="font-size:11px">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, PDF</span></div>
            </div>
            <div class="form-group"><label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input class="form-input" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©" /></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Summary sticky -->
      <div>
        <div style="position:sticky;top:20px">
          <div style="background:var(--surface);border:2px solid var(--accent);border-radius:var(--rl);padding:24px;box-shadow:var(--sh-l)">
            <div style="font-weight:700;font-size:16px;margin-bottom:16px">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</div>

            <div style="display:flex;justify-content:space-between;padding:10px 0;font-size:13px;border-bottom:1px solid var(--border)"><span style="color:var(--text-s)">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span class="mono" style="font-weight:600" id="collect-total">‚Äî</span></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;font-size:13px;border-bottom:1px solid var(--border)"><span style="color:var(--text-s)">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏≥‡∏£‡∏∞</span><span style="font-weight:600" id="pay-sel-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;font-size:13px;border-bottom:1px solid var(--border)"><span style="color:var(--text-s)">‡∏¢‡∏≠‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span><span class="mono" style="font-weight:600" id="pay-sel-amt">‚Äî</span></div>

            <div style="margin-top:12px;padding:12px;background:var(--surface-alt);border-radius:var(--r);border:1px solid var(--border)">
              <div style="font-size:12px;font-weight:600;color:var(--text-s);margin-bottom:8px">üí∞ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</div>
              <div id="pay-ch-summary"></div>
              <div style="display:flex;justify-content:space-between;padding:8px 0 0;font-size:16px;font-weight:700;border-top:1px solid var(--border);margin-top:6px">
                <span>‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏ß‡∏°</span>
                <span class="mono" style="color:var(--green)" id="pay-total-paid">‡∏ø0.00</span>
              </div>
            </div>

            <div style="display:flex;justify-content:space-between;padding:14px 0 8px;font-size:16px;font-weight:700;border-top:2px solid var(--text);margin-top:12px">
              <span>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</span>
              <span class="mono" id="pay-diff" style="color:var(--text-m)">‚Äî</span>
            </div>

            <div style="margin:12px 0 20px" id="pay-status-badge">
              <span class="badge b-blue"><span class="dot"></span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</span>
            </div>

            <button class="btn btn-g btn-lg" style="width:100%;font-size:16px" onclick="confirmSubmit()">üì§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          </div>

          <div style="background:var(--orange-l);border:1px solid rgba(154,112,32,.2);border-radius:var(--r);padding:16px;margin-top:16px;font-size:12px;color:var(--orange)">
            ‚ö†Ô∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br>
            üí° ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡πÑ‡∏î‡πâ<br>
            üí° ‡∏Å‡∏î "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î + ‡πÇ‡∏≠‡∏ô
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ============ STAFF: SUBMIT STATUS ============ -->
<div class="page" id="page-staff-submit">
  <div class="top-bar"><div><div class="pg-title">üì§ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="pg-desc">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div></div><div class="role-tag role-tag-staff">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></div>
  <div class="content">
    <div class="in-tabs mb-24"><button class="in-tab active" onclick="switchInTab(this,'submit-pending')">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button class="in-tab" onclick="switchInTab(this,'submit-done')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button><button class="in-tab" onclick="switchInTab(this,'submit-return')">‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div>
    <div id="submit-pending">
    <div id="staff-submit-pending" style="text-align:center;padding:24px;color:var(--text-m)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
    </div>

    <div id="submit-done" style="display:none">
    <div id="staff-submit-done" style="text-align:center;padding:24px;color:var(--text-m)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
    </div>

    <div id="submit-return" style="display:none">
      <div style="text-align:center;padding:40px;color:var(--text-m)">
        <div style="font-size:32px;margin-bottom:12px">‚úÖ</div>
        <div style="font-size:14px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</div>
      </div>
    </div>
  </div>
</div>

<!-- ============ STAFF: RECEIPT ============ -->
<div class="page" id="page-staff-receipt">
  <div class="top-bar"><div><div class="pg-title">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><div class="pg-desc">‡∏≠‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Äî ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</div></div><div class="flex gap-8"><button class="btn btn-o" onclick="goPage('staff-submit')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button><button class="btn btn-p">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button></div></div>
  <div class="content">
    <div class="receipt-preview">
      <div class="inv-head">
        <div><div class="inv-title">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><div class="inv-no" id="rec-no">‚Äî</div><div style="font-size:12px;margin-top:4px;color:var(--text-s)">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div></div>
        <div style="text-align:right"><div class="receipt-stamp">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div><div style="margin-top:8px"><div class="inv-ml">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</div><div style="font-weight:600" id="rec-issue-date">‚Äî</div></div></div>
      </div>
      <div class="inv-grid">
        <div><div class="inv-ml">‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ</div><div style="font-weight:600;font-size:15px" id="rec-cust">‚Äî</div><div style="font-size:12px;color:var(--text-s)" id="rec-code">‚Äî</div></div>
        <div><div class="inv-ml">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div><div style="font-weight:600;font-size:15px" id="rec-inv">‚Äî</div></div>
      </div>
      <table class="inv-table"><thead><tr><th style="text-align:left">#</th><th style="text-align:left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:left">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
      <tbody id="rec-items-tbody">
        <tr><td colspan="4" style="text-align:center;color:var(--text-m);padding:24px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</td></tr>
      </tbody></table>
      <div style="display:flex;justify-content:flex-end"><div class="inv-total-box"><div style="font-size:11px;opacity:.7">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</div><div style="font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700" id="rec-total">‚Äî</div><div style="font-size:11px;opacity:.7;margin-top:2px" id="rec-total-text">‚Äî</div></div></div>

      <!-- Payment details -->
      <div style="margin-top:24px;padding:16px 20px;background:var(--green-l);border-radius:var(--r);border:1px solid rgba(74,122,82,.2)">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--green);margin-bottom:8px">üí≥ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;font-size:13px" id="rec-pay-detail">
          <div><div style="color:var(--text-m);font-size:10px;text-transform:uppercase">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div><div style="font-weight:600;margin-top:2px" id="rec-channel">‚Äî</div></div>
          <div><div style="color:var(--text-m);font-size:10px;text-transform:uppercase">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div><div style="font-weight:600;margin-top:2px" id="rec-bank">‚Äî</div></div>
          <div><div style="color:var(--text-m);font-size:10px;text-transform:uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</div><div style="font-weight:600;margin-top:2px" id="rec-date">‚Äî</div></div>
        </div>
      </div>

      <!-- Signatures -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:32px;padding-top:24px;border-top:2px solid var(--border)">
        <div style="text-align:center"><div class="sign-line"></div><div class="sign-label">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</div></div>
        <div style="text-align:center"><div class="sign-line"></div><div class="sign-label">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ============ STAFF: REPORT ============ -->
<div class="page" id="page-staff-report">
  <div class="top-bar"><div><div class="pg-title">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</div><div class="pg-desc">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</div></div><div class="flex gap-8"><button class="btn btn-p btn-sm" onclick="exportReportPDF('staff')">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button></div></div>
  <div class="content" id="report-area-staff"></div>
</div>

<!-- ============ STAFF: HISTORY ============ -->
<div class="page" id="page-staff-history">
  <div class="top-bar"><div><div class="pg-title">üïê ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><div class="pg-desc">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div></div><div class="role-tag role-tag-staff">üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></div>
  <div class="content">
    <div class="card"><div class="tbl-w"><table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
    <tbody id="staff-hist-tb">
      <tr><td colspan="6" style="text-align:center;color:var(--text-m);padding:24px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</td></tr>
    </tbody></table></div></div>
  </div>
</div>

</div><!-- /main-area -->
</div><!-- /app -->

<!-- ===== MODAL: Add Customer ===== -->
<div class="modal-bg" id="modal-add-cust">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div><button class="btn btn-ghost btn-sm" onclick="closeModal('add-cust')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid mb-24">
        <div class="form-group"><label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input class="form-input mono" placeholder="‡πÄ‡∏ä‡πà‡∏ô NS0001" /></div>
        <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</label><input class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" /></div>
        <div class="form-group full"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input class="form-input" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ" /></div>
        <div class="form-group"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label><input class="form-input mono" placeholder="x-xxxx-xxxxx-xx-x" /></div>
        <div class="form-group"><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input class="form-input" placeholder="0xx-xxx-xxxx" /></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--text-s);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ + ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏û 30</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 3,53</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏ò 40</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 90</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ö ‡∏ö‡∏ä</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 51</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 50</span><input style="width:90px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" placeholder="0" /></div>
      </div>
    </div>
    <div class="modal-foot"><button class="btn btn-o" onclick="closeModal('add-cust')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-p" onclick="closeModal('add-cust')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
  </div>
</div>

<!-- ===== IMAGE VIEWER ===== -->
<div class="img-viewer" id="img-viewer" onclick="this.classList.remove('show')">
  <img id="img-viewer-src" src="" />
</div>

<!-- ===== MODAL: Edit Customer ===== -->
<div class="modal-bg" id="modal-edit-cust">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><button class="btn btn-ghost btn-sm" onclick="closeModal('edit-cust')">‚úï</button></div>
    <div class="modal-body">
      <div class="hb hb-purple mb-16 flex items-c gap-12">
        <span style="font-size:24px">üë§</span>
        <div><div style="font-weight:700;font-size:17px" id="edit-cust-title">‚Äî</div><div style="font-size:12px;color:var(--text-s)" id="edit-cust-code">‚Äî</div></div>
      </div>
      <input type="hidden" id="edit-cust-idx" />
      <div class="form-grid mb-24">
        <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</label><input class="form-input" id="edit-cust-name" /></div>
        <div class="form-group"><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input class="form-input" id="edit-cust-phone" /></div>
        <div class="form-group full"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input class="form-input" id="edit-cust-address" /></div>
        <div class="form-group"><label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label><input class="form-input mono" id="edit-cust-taxid" /></div>
        <div class="form-group"><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select class="form-select" id="edit-cust-status"><option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="‡∏£‡∏∞‡∏á‡∏±‡∏ö">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option></select></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--text-s);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-accounting" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏û 30</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-vat" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 3,53</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-wht" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏ò 40</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-sbt" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏†‡∏á‡∏î 90</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-pnd90" /></div>
        <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs)"><span style="font-size:13px;font-weight:500;flex:1">‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ö ‡∏ö‡∏ä</span><input style="width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:12px;text-align:right" id="edit-cust-audit" /></div>
      </div>
      <div class="hb hb-orange mt-16" style="font-size:12px;color:var(--orange)">üí° ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô</div>
    </div>
    <div class="modal-foot"><button class="btn btn-o" onclick="closeModal('edit-cust')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="btn btn-p" onclick="saveEditCust()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
  </div>
</div>

<script>
// ===================================================================
// üîß CONFIG ‚Äî ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script Web App ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
// ===================================================================
const API_URL = 'https://script.google.com/macros/s/AKfycbx3clLD_q34LVDHTD9sXWc_euvhrWkLeib7Px-yhpO0u971U3kqWqJdW0WFZMkSPxCY/exec';  // ‚Üê ‡∏ß‡∏≤‡∏á URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏ä‡πà‡∏ô 'https://script.google.com/macros/s/AKfycbx.../exec'

// ===== API HELPERS =====
async function apiGet(action, params = {}) {
  if (!API_URL) return null;
  const url = new URL(API_URL);
  url.searchParams.set('action', action);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
  try { const r = await fetch(url); return await r.json(); }
  catch (e) { console.error('API:', e); return null; }
}
async function apiPost(action, data = {}) {
  if (!API_URL) return null;
  try { const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action,...data}) }); return await r.json(); }
  catch (e) { console.error('API:', e); return null; }
}

// ===== STATE =====
let loginRole = 'mgr', pinCode = '', currentUser = null, allCustomers = [], appSettings = {};
const PIN_LEN = { mgr:5, staff:4 };

// ===== HELPERS =====
function fmtBaht(v) { return '‡∏ø' + (v||0).toLocaleString(); }
function statusBadge(s) {
  const map = { '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞':'b-red', '‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î':'b-orange', '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß':'b-green', '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞':'b-blue', '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥':'b-orange', '‡∏õ‡∏Å‡∏ï‡∏¥':'b-green' };
  return '<span class="badge '+(map[s]||'b-blue')+'"><span class="dot"></span>'+(s||'‡∏õ‡∏Å‡∏ï‡∏¥')+'</span>';
}

// ===== LOGIN =====
function selectLoginRole(r) {
  loginRole = r; pinCode = '';
  document.getElementById('rc-mgr').className = 'role-choice' + (r==='mgr' ? ' sel-mgr' : '');
  document.getElementById('rc-staff').className = 'role-choice' + (r==='staff' ? ' sel-staff' : '');
  document.getElementById('pin-label').textContent = r==='mgr' ? '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å' : '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å';
  renderDots(); document.getElementById('pin-err').textContent = '';
}
function renderDots() {
  const len = PIN_LEN[loginRole]; let h = '';
  for (let i=0;i<len;i++) h += '<div class="pin-dot'+(i<pinCode.length?' filled':'')+'"></div>';
  document.getElementById('pin-dots').innerHTML = h;
}
function pinInput(n) { if(pinCode.length>=PIN_LEN[loginRole])return; pinCode+=n; renderDots(); if(pinCode.length===PIN_LEN[loginRole]) setTimeout(checkPin,200); }
function pinBack() { pinCode=pinCode.slice(0,-1); renderDots(); document.getElementById('pin-err').textContent=''; }
function pinClear() { pinCode=''; renderDots(); document.getElementById('pin-err').textContent=''; }

async function checkPin() {
  const errEl = document.getElementById('pin-err');
  errEl.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...'; errEl.style.color = 'var(--blue)';

  if (!API_URL) {
    // DEMO MODE
    const PINS = { mgr:'12345', staff:'1234' };
    if (pinCode === PINS[loginRole]) {
      currentUser = { name: loginRole==='mgr'?'‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£':'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', code: loginRole==='mgr'?'MGR-001':'STF-001' };
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app').style.display = 'flex';
      setupRole(loginRole);
    } else { showPinError(); }
    return;
  }

  const result = await apiGet('verifyPin', { role:loginRole, pin:pinCode });
  if (result && result.success) {
    currentUser = { name:result.name, code:result.code };
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').style.display = 'flex';
    setupRole(loginRole);
  } else { showPinError(); }
}

function showPinError() {
  const e = document.getElementById('pin-err'); e.textContent='‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; e.style.color='var(--red)';
  document.querySelectorAll('.pin-dot').forEach(d=>d.classList.add('wrong'));
  setTimeout(()=>{ pinCode=''; renderDots(); }, 600);
}
renderDots();

// ===== ROLE SETUP =====
// ===== MONTH HELPERS =====
const THAI_MONTHS = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
const THAI_MONTHS_FULL = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

function populateEntryMonths() {
  const sel = document.getElementById('entry-month');
  if (!sel) return;
  sel.innerHTML = '';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const m = d.getMonth();
    const thaiYear = d.getFullYear() + 543;
    const shortYear = String(thaiYear).slice(-2);
    const val = THAI_MONTHS[m] + ' ' + shortYear;
    const label = THAI_MONTHS_FULL[m] + ' ' + thaiYear;
    const opt = document.createElement('option');
    opt.value = val; opt.textContent = label;
    if (i === 0) opt.selected = true;
    sel.appendChild(opt);
  }
  updateEntryMonthLabels();
}

function updateEntryMonthLabels() {
  const sel = document.getElementById('entry-month');
  if (!sel || !sel.options.length) return;
  const label = sel.options[sel.selectedIndex].textContent;
  const $=id=>document.getElementById(id);
  if($('entry-month-title')) $('entry-month-title').textContent = label;
  if($('entry-total-label')) $('entry-total-label').textContent = label;
  if($('sel-cust-sub')) $('sel-cust-sub').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î: ' + label;
}

function onEntryMonthChange() { updateEntryMonthLabels(); resetEntryArea(); }

// ===== REFRESH =====
async function refreshData() {
  const btn = document.getElementById('btn-refresh');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ ‡πÇ‡∏´‡∏•‡∏î...'; }
  try {
    await loadSettings();
    await loadCustomers();
    await loadDashboard(loginRole);
  } catch(e) { console.error('Refresh error:', e); }
  if (btn) { btn.disabled = false; btn.textContent = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä'; }
}

async function loadSettings() {
  const data = await apiGet('getSettings');
  if (data && !data.error) appSettings = data;
}

async function setupRole(role) {
  const badge = document.getElementById('sb-role-badge');
  const name = currentUser ? currentUser.name : (role==='mgr'?'‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£':'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
  if (role==='mgr') {
    badge.className='sb-role sb-role-mgr'; badge.textContent='üëî '+name;
    document.getElementById('nav-mgr').style.display='block';
    document.getElementById('nav-staff').style.display='none';
    goPage('mgr-dash');
  } else {
    badge.className='sb-role sb-role-staff'; badge.textContent='üë©‚Äçüíº '+name;
    document.getElementById('nav-mgr').style.display='none';
    document.getElementById('nav-staff').style.display='block';
    const sn=document.getElementById('staff-role-name');
    if(sn) sn.textContent='üë©‚Äçüíº ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: '+name;
    goPage('staff-dash');
  }
  populateEntryMonths();
  // Set today's date for entry calc
  const ecd = document.getElementById('entry-calc-date');
  if (ecd) ecd.value = new Date().toISOString().split('T')[0];
  loadSettings();
  loadCustomers();
  loadDashboard(role);
}

function logout() {
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').classList.remove('hidden');
  pinCode=''; currentUser=null; allCustomers=[];
  renderDots(); document.getElementById('pin-err').textContent='';
}

// ===== DATA LOADING =====
async function loadCustomers() {
  const data = await apiGet('getCustomers');
  allCustomers = (data && !data.error) ? data : [];
  renderCustomerTables();
  renderEntrySearch();
}

function renderCustomerTables() {
  const mgrTb = document.getElementById('mgr-cust-tb');
  const stfTb = document.getElementById('staff-cust-tb');
  if (!allCustomers.length) {
    const e7 = '<tr><td colspan="7" style="text-align:center;color:var(--text-m);padding:24px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‚Äî ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Google Sheets ‡πÅ‡∏ó‡πá‡∏ö "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"</td></tr>';
    if(mgrTb) mgrTb.innerHTML=e7;
    if(stfTb) stfTb.innerHTML=e7.replace('7','6');
    return;
  }
  let mH='', sH='';
  allCustomers.forEach((c, idx) => {
    const sc = c.svcCount || 0;
    const mo = c.monthlyRate || 0;
    const sb = statusBadge(c.status);
    const ow = c.outstanding || 0;
    const owHtml = ow > 0 ? '<span style="color:var(--red);font-weight:600">' + fmtBaht(ow) + '</span>' + (c.monthsOwed ? ' <span class="badge b-red" style="font-size:10px">' + c.monthsOwed + ' ‡∏î.</span>' : '') : '<span style="color:var(--green)">‚Äî</span>';
    const scBadge = sc > 0 ? '<span class="badge b-blue">' + sc + ' ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>' : '<span class="badge" style="background:var(--surface-alt);color:var(--text-m)">0 ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>';
    mH += '<tr><td class="mono">' + esc(c.code) + '</td><td><strong>' + esc(c.name) + '</strong></td><td>' + scBadge + '</td><td class="text-r mono">' + (mo > 0 ? fmtBaht(mo) : '<span style="color:var(--text-m)">‚Äî</span>') + '</td><td>' + sb + '</td><td class="text-r">' + owHtml + '</td><td class="text-r"><button class="btn btn-ghost btn-sm" onclick="openEditCust(' + idx + ')">‚úèÔ∏è</button></td></tr>';
    sH += '<tr><td class="mono">' + esc(c.code) + '</td><td><strong>' + esc(c.name) + '</strong></td><td>' + scBadge + '</td><td class="text-r mono">' + (mo > 0 ? fmtBaht(mo) : '<span style="color:var(--text-m)">‚Äî</span>') + '</td><td>' + sb + '</td><td class="text-r">' + owHtml + '</td></tr>';
  });
  if(mgrTb) mgrTb.innerHTML=mH;
  if(stfTb) stfTb.innerHTML=sH;
}

function renderEntrySearch() {
  const c = document.getElementById('search-results');
  if(!c) return;
  if(!allCustomers.length) { c.innerHTML='<div style="padding:14px 20px;color:var(--text-m);text-align:center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>'; return; }
  c.innerHTML = allCustomers.map(cu =>
    '<div class="search-result-item" data-search="'+cu.code+' '+cu.name+'" onclick="selectCustEntry(\''+cu.code.replace(/'/g,"\\'")+'\',\''+cu.name.replace(/'/g,"\\'")+'\')"><span class="search-result-code">'+cu.code+'</span><strong>'+cu.name+'</strong></div>'
  ).join('');
}

function filterCustTable(val, tbId) {
  const tb = document.getElementById(tbId);
  if (!tb) return;
  const q = val.toLowerCase();
  tb.querySelectorAll('tr').forEach(tr => {
    tr.style.display = !q || tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function filterEntrySearch(val) {
  const q = val.toLowerCase();
  document.querySelectorAll('#search-results .search-result-item').forEach(item => {
    const text = (item.dataset.search || item.textContent).toLowerCase();
    item.style.display = !q || text.includes(q) ? '' : 'none';
  });
}

async function loadDashboard(role) {
  const d = await apiGet('getDashboard', {role});
  if(!d||d.error) return;

  // Update dashboard month label
  const $=id=>document.getElementById(id);
  if($('mgr-dash-month') && d.currentMonth) $('mgr-dash-month').textContent='‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ¬∑ '+d.currentMonth;

  // Update nav badge counts
  if($('nav-approve-count') && d.pendingCount>0) { $('nav-approve-count').textContent=d.pendingCount; $('nav-approve-count').style.display=''; }
  if($('nav-submit-count') && d.pendingCount>0) { $('nav-submit-count').textContent=d.pendingCount; $('nav-submit-count').style.display=''; }

  if(role==='mgr') {
    if($('mgr-s-cust')) $('mgr-s-cust').textContent=d.totalCustomers||0;
    if($('mgr-s-billed')) $('mgr-s-billed').textContent=fmtBaht(d.totalBilled);
    if($('mgr-s-paid')) $('mgr-s-paid').textContent=fmtBaht(d.totalPaid);
    if($('mgr-s-paid-pct')) $('mgr-s-paid-pct').textContent=(d.paidPercent||0)+'%';
    if($('mgr-s-pending')) $('mgr-s-pending').textContent=d.pendingCount||0;
    if($('mgr-s-pending-sub')) $('mgr-s-pending-sub').textContent=fmtBaht(d.pendingTotal);
    const outTb=$('mgr-outstanding-tb');
    if(outTb) {
      if(!d.topOutstanding||!d.topOutstanding.length) outTb.innerHTML='<tr><td colspan="3" style="text-align:center;color:var(--green);padding:24px">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td></tr>';
      else outTb.innerHTML=d.topOutstanding.map(o=>'<tr><td><strong>'+o.name+'</strong> <span class="mono" style="color:var(--text-m)">'+o.code+'</span></td><td class="text-r mono" style="color:var(--red)">'+fmtBaht(o.amount)+'</td><td><span class="badge b-red"><span class="dot"></span>'+(o.months||1)+' ‡∏î.</span></td></tr>').join('');
    }
    const pl=$('mgr-pending-list');
    if(pl) {
      if(!d.pendingApproval||!d.pendingApproval.length) pl.innerHTML='<div style="text-align:center;color:var(--green);padding:24px">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
      else pl.innerHTML=d.pendingApproval.map(p=>'<div class="approval-card pending"><div class="flex items-c jc-b"><div><div style="font-weight:600">'+p.custName+' ¬∑ '+fmtBaht(p.amount)+'</div><div style="font-size:12px;color:var(--text-s)">'+p.channel+' ¬∑ '+p.staff+' ¬∑ '+p.date+'</div></div><span class="badge b-orange"><span class="dot"></span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span></div></div>').join('');
    }
  } else {
    // Staff dashboard
    if($('stf-s-inv')) $('stf-s-inv').textContent=d.pendingCount||0;
    if($('stf-s-wait')) $('stf-s-wait').textContent=fmtBaht(d.totalBilled-d.totalPaid);
    if($('stf-s-done')) $('stf-s-done').textContent=fmtBaht(d.totalPaid);
    if($('stf-s-pend')) $('stf-s-pend').textContent=d.pendingCount||0;
    if($('staff-dash-desc') && d.currentMonth) $('staff-dash-desc').textContent='‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö ¬∑ '+d.currentMonth;
  }
}

// ===== NAVIGATION =====
function goPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const t=document.getElementById('page-'+id); if(t) t.classList.add('active');
  document.querySelectorAll('.nav-i').forEach(n=>{
    n.classList.remove('active');
    if(n.getAttribute('onclick')?.includes("'"+id+"'")) n.classList.add('active');
  });
  window.scrollTo({top:0,behavior:'instant'});
}

// ===== MODAL =====
function openModal(n){document.getElementById('modal-'+n).classList.add('show')}
function closeModal(n){document.getElementById('modal-'+n).classList.remove('show')}
document.querySelectorAll('.modal-bg').forEach(b=>b.addEventListener('click',e=>{if(e.target===b) b.classList.remove('show')}));

function openImgViewer(src){document.getElementById('img-view-src').src=src;openModal('img-view')}

// ===== PAYMENT (Collect) =====
function selPayCh(el){
  // Radio: deselect siblings, select this one
  const parent = el.parentElement;
  parent.querySelectorAll('.pay-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
  // Show/hide bank fields based on method
  const method = el.querySelector('div:last-child').textContent.trim();
  const channel = el.closest('.pay-channel');
  if (channel) {
    const bankRow = channel.querySelector('.pay-bank-row');
    if (bankRow) bankRow.style.display = (method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') ? 'none' : 'grid';
  }
}

let payChannelCount = 1;
function addPayChannel(){
  payChannelCount++;
  const n = payChannelCount;
  const tpl = document.getElementById('pay-channel-tpl');
  if (!tpl) return;
  const html = tpl.innerHTML.replace(/\{N\}/g, n);
  const wrapper = document.createElement('div');
  wrapper.innerHTML = html;
  const newCh = wrapper.firstElementChild;
  document.getElementById('pay-channels').appendChild(newCh);
  // Default to first method
  const firstOpt = newCh.querySelector('.pay-opt');
  if (firstOpt) selPayCh(firstOpt);
}
function removePayChannel(n){const e=document.getElementById('pay-ch-'+n);if(e)e.remove();updatePayTotal()}

function updatePayTotal(){
  const inputs=document.querySelectorAll('.pay-amt-input');
  let totalPaid=0; inputs.forEach(i=>totalPaid+=parseFloat(i.value.replace(/,/g,''))||0);
  // Calculate expected from selected pay items
  let expected=0; document.querySelectorAll('.pay-item.sel').forEach(e=>expected+=parseFloat(e.dataset.amt||0));
  const diff=totalPaid-expected;
  const tE=document.getElementById('pay-total-paid');
  if(tE) tE.textContent=fmtBaht(totalPaid);
  const dE=document.getElementById('pay-diff'),dB=document.getElementById('pay-status-badge');
  if(totalPaid===0){ if(dE){dE.textContent='‚Äî';dE.style.color='var(--text-m)'} if(dB){dB.innerHTML='<span class="badge b-blue"><span class="dot"></span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</span>'} return; }
  if(dE){dE.textContent=(diff>=0?'+':'')+fmtBaht(diff);dE.style.color=diff===0?'var(--green)':diff>0?'var(--blue)':'var(--red)'}
  if(dB){if(diff===0){dB.innerHTML='<span class="badge b-green"><span class="dot"></span>‚úÖ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á</span>'}else if(diff>0){dB.innerHTML='<span class="badge b-blue"><span class="dot"></span>üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô</span>'}else{dB.innerHTML='<span class="badge b-red"><span class="dot"></span>‚ö†Ô∏è ‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏î</span>'}}
}

let _payUpdateTimer = null;
function togglePayItem(el){
  el.classList.toggle('sel');
  // Debounce: update summary after rapid clicks settle
  clearTimeout(_payUpdateTimer);
  _payUpdateTimer = setTimeout(() => { updatePaySummary(); updatePayTotal(); }, 80);
}
function toggleMonthAll(monthGroup, select){
  monthGroup.querySelectorAll('.pay-item').forEach(e => select ? e.classList.add('sel') : e.classList.remove('sel'));
  updatePaySummary();updatePayTotal();
}
function toggleAllPay(s){document.querySelectorAll('.pay-item').forEach(e=>s?e.classList.add('sel'):e.classList.remove('sel'));updatePaySummary();updatePayTotal()}
function updatePaySummary(){
  const it=document.querySelectorAll('.pay-item.sel');let t=0;it.forEach(e=>t+=parseFloat(e.dataset.amt||0));
  const s=document.getElementById('pay-sel-amt'),c=document.getElementById('pay-sel-count');
  if(s) s.textContent=fmtBaht(t); if(c) c.textContent=it.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  // Auto-fill first channel amount if only 1 channel and amount is empty or was auto-filled
  const firstAmt = document.getElementById('pay-ch-1-amt');
  if (firstAmt && document.querySelectorAll('.pay-channel').length === 1) {
    if (!firstAmt.value || firstAmt.dataset.autoFilled === 'true') {
      firstAmt.value = t > 0 ? t.toLocaleString('en-US', {minimumFractionDigits: 0}) : '';
      firstAmt.dataset.autoFilled = 'true';
      updatePayTotal();
    }
  }
}

let collectCustCode='',collectCustName='';
async function loadCollectItems(custCode, custName) {
  collectCustCode = custCode;
  collectCustName = custName || custCode;
  // Set today's date on date inputs
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('.pay-channel input[type="date"]').forEach(d => d.value = today);
  // Reset auto-fill flag
  const firstAmt = document.getElementById('pay-ch-1-amt');
  if (firstAmt) { firstAmt.value = ''; firstAmt.dataset.autoFilled = 'true'; firstAmt.onfocus = function(){ this.dataset.autoFilled = 'false'; }; }
  const hdr = document.getElementById('collect-header');
  if(hdr) hdr.textContent = custCode + ' ‚Äî ' + (custName||'');
  const sub = document.getElementById('collect-sub');
  if(sub) sub.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞...';
  const list = document.getElementById('collect-items-list');
  if(list) list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

  const data = await apiGet('getUnpaidItems', { custCode });
  if (!data || data.error) {
    if(list) list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--red)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    return;
  }
  // Separate: unpaid (selectable) vs pending (disabled)
  const unpaid = data.filter(it => !it.paid && !it.pending);
  const pending = data.filter(it => it.pending);
  if (!unpaid.length) {
    if(list) list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--green)"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>';
    if(sub) sub.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
    return;
  }
  
  // Group by month
  const byMonth = {};
  unpaid.forEach(it => {
    if(!byMonth[it.month]) byMonth[it.month] = [];
    byMonth[it.month].push(it);
  });
  const months = Object.keys(byMonth).sort();
  
  let totalAll = 0;
  let html = '';
  months.forEach(m => {
    const items = byMonth[m];
    const monthTotal = items.reduce((s,it) => s + it.amount, 0);
    totalAll += monthTotal;
    html += '<div class="pay-month-group" data-month="' + m + '">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:var(--surface-alt);border-bottom:1px solid var(--border);cursor:pointer" onclick="toggleMonthAll(this.parentElement,!this.parentElement.querySelector(\'.pay-item:not(.sel)\'))">';
    html += '<div style="font-weight:700;font-size:14px">üìÖ ' + m + ' <span style="font-size:12px;font-weight:400;color:var(--text-m)">(' + items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span></div>';
    html += '<div class="flex items-c gap-8"><span class="mono" style="font-weight:600">' + fmtBaht(monthTotal) + '</span><button class="btn btn-sm btn-o" onclick="event.stopPropagation();toggleMonthAll(this.closest(\'.pay-month-group\'),true)">‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button></div>';
    html += '</div>';
    items.forEach(it => {
      html += '<div class="pay-item" data-amt="' + it.amount + '" data-month="' + it.month + '" data-svc="' + it.serviceKey + '" onclick="togglePayItem(this)">';
      html += '<div class="flex items-c gap-12"><div class="pay-check" style="width:22px;height:22px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:14px"></div>';
      html += '<div><div style="font-weight:500">' + it.serviceLabel + '</div><div style="font-size:11px;color:var(--text-m)">' + it.month + '</div></div></div>';
      html += '<div class="mono" style="font-weight:700;font-size:15px">' + fmtBaht(it.amount) + '</div>';
      html += '</div>';
    });
    html += '</div>';
  });
  
  // Add pending section
  if (pending.length) {
    const pendTotal = pending.reduce((s,it) => s + it.amount, 0);
    html += '<div style="padding:12px 20px;background:var(--orange-l,#fff8e6);border-top:2px solid var(--orange);font-size:13px;color:var(--orange)"><strong>‚è≥ ' + pending.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (' + fmtBaht(pendTotal) + ')</strong> ‚Äî ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</div>';
  }
  
  if(list) list.innerHTML = html;
  if(sub) sub.textContent = unpaid.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' + (pending.length ? ' + ' + pending.length + ' ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '') + ' ¬∑ ' + months.length + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ¬∑ ‡∏£‡∏ß‡∏° ' + fmtBaht(totalAll);
  const ct = document.getElementById('collect-total');
  if(ct) ct.textContent = fmtBaht(totalAll);
  updatePaySummary();
}

// ===== ENTRY PAGE =====
async function selectCustEntry(code, name) {
  document.getElementById('mgr-cust-search').value=code+' ‚Äî '+name;
  document.getElementById('sel-cust-name').textContent=code+' ‚Äî '+name;
  document.getElementById('search-results').classList.remove('show');
  document.getElementById('entry-area').style.display='block';
  document.getElementById('sel-cust-sub').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  clearAllSvc();
  const ms=document.getElementById('entry-month');
  const month=ms?ms.value:'‡∏°.‡∏Ñ. 69';
  window._entryCust={code,name,month};
  window._entryEditMode=false;

  if(API_URL){
    // Check if entry already exists for this month
    const existing = await apiGet('getEntry', {custCode: code, month});
    if (existing && existing.found) {
      // EDIT MODE: load existing data
      window._entryEditMode = true;
      document.getElementById('sel-cust-sub').innerHTML = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î: <strong>' + month + '</strong> <span class="badge b-blue">‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</span>';
      const keys = ['accounting','vat','wht','sbt','pnd90','pnd94','audit','pnd51','pnd50','other'];
      const rows = document.querySelectorAll('#entry-area .svc-row-lg');
      keys.forEach((k,i) => {
        if (!rows[i]) return;
        const inp = rows[i].querySelector('.svc-input-lg');
        const v = existing.amounts[k] || 0;
        if (inp && v > 0) { inp.value = v.toLocaleString(); rows[i].classList.add('has-val'); }
      });
      updateEntryTotal();
      // Also load prev month for reference
      const prev = await apiGet('getPrevMonth', {custCode:code, currentMonth:month});
      if (prev && prev.found) showPrevBanner(prev); else hidePrevBanner();
      // Change save button text
      const saveBtn = document.querySelector('#entry-area .btn-p[onclick*="saveEntry"]');
      if (saveBtn) saveBtn.innerHTML = 'üíæ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î';
    } else {
      // NEW MODE
      document.getElementById('sel-cust-sub').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà: ' + month;
      const prev = await apiGet('getPrevMonth', {custCode:code, currentMonth:month});
      if (prev && prev.found) showPrevBanner(prev); else showNewBanner();
      const saveBtn = document.querySelector('#entry-area .btn-p[onclick*="saveEntry"]');
      if (saveBtn) saveBtn.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î';
    }
  } else { showNewBanner(); }
  window.scrollTo({top:document.getElementById('entry-area').offsetTop-80,behavior:'smooth'});
}
function hidePrevBanner() {
  const pb = document.getElementById('prev-month-banner'); if (pb) pb.style.display = 'none';
  const nb = document.getElementById('new-cust-banner'); if (nb) nb.style.display = 'none';
}

function showPrevBanner(prev){
  document.getElementById('prev-month-banner').style.display='block';
  document.getElementById('new-cust-banner').style.display='none';
  document.getElementById('prev-month-label').textContent=prev.month;
  document.getElementById('prev-month-total').textContent=fmtBaht(prev.total);
  window._prevData=prev.amounts;
  const keys=['accounting','vat','wht','sbt','pnd90','pnd94','other'];
  const rows=document.querySelectorAll('#entry-area .svc-row-lg');
  keys.forEach((k,i)=>{
    if(!rows[i])return; const pd=rows[i].querySelector('.svc-prev'), v=prev.amounts[k]||0;
    if(pd&&v>0){pd.style.display='inline-block';pd.textContent='‡πÄ‡∏î‡∏¥‡∏°: '+v.toLocaleString();pd.dataset.val=v;
      pd.onclick=function(){rows[i].querySelector('.svc-input-lg').value=v.toLocaleString();rows[i].classList.add('has-val');updateEntryTotal()};
    } else if(pd) pd.style.display='none';
  });
}

function showNewBanner(){
  document.getElementById('prev-month-banner').style.display='none';
  document.getElementById('new-cust-banner').style.display='block';
  document.querySelectorAll('#entry-area .svc-prev').forEach(d=>d.style.display='none');
  window._prevData=null;
}

function fillAllPrev(){
  if(!window._prevData)return;
  const keys=['accounting','vat','wht','sbt','pnd90','pnd94','other'];
  const rows=document.querySelectorAll('#entry-area .svc-row-lg');
  keys.forEach((k,i)=>{if(rows[i]&&window._prevData[k]>0){rows[i].querySelector('.svc-input-lg').value=window._prevData[k].toLocaleString();rows[i].classList.add('has-val')}});
  document.getElementById('prev-month-banner').style.display='none';
  updateEntryTotal();
}

function clearAllSvc(){document.querySelectorAll('#entry-area .svc-row-lg').forEach(r=>{const i=r.querySelector('.svc-input-lg');if(i)i.value='';r.classList.remove('has-val')});updateEntryTotal()}
function resetEntryArea(){document.getElementById('entry-area').style.display='none';document.getElementById('mgr-cust-search').value='';clearAllSvc();window._entryCust=null}

function updateEntryTotal(){
  let t=0,c=0;
  document.querySelectorAll('#entry-area .svc-input-lg').forEach(i=>{
    const v=parseFloat(i.value.replace(/,/g,''))||0;if(v>0){t+=v;c++}
    const r=i.closest('.svc-row-lg');if(r){v>0?r.classList.add('has-val'):r.classList.remove('has-val')}
  });
  const tE=document.getElementById('entry-total-val');if(tE)tE.textContent=fmtBaht(t);
  const cE=document.getElementById('entry-item-count');if(cE)cE.textContent=c+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
}

async function saveEntry(){
  const inputs=document.querySelectorAll('#entry-area .svc-input-lg');
  const keys=['accounting','vat','wht','sbt','pnd90','pnd94','other','audit','pnd51','pnd50'];
  let t=0,c=0;const amounts={};
  inputs.forEach((inp,i)=>{const v=parseFloat(inp.value.replace(/,/g,''))||0;if(v>0){t+=v;c++}if(keys[i])amounts[keys[i]]=v});
  if(c===0){alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');return}
  if(!window._entryCust){alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');return}
  const cu=window._entryCust;
  const confirmMsg = window._entryEditMode
    ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏¢‡∏≠‡∏î?\n\n'+cu.code+' ‚Äî '+cu.name+'\n‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: '+cu.month+'\n'+c+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: '+fmtBaht(t)+'\n\n‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö'
    : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î?\n\n'+cu.code+' ‚Äî '+cu.name+'\n‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: '+cu.month+'\n'+c+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: '+fmtBaht(t);
  if(!confirm(confirmMsg))return;
  if(API_URL){
    const r=await apiPost('saveEntry',{custCode:cu.code,custName:cu.name,month:cu.month,...amounts});
    if(r&&r.success){alert('‚úÖ '+r.message+'\n\n‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ');resetEntryArea()}
    else alert('‚ùå '+(r?.error||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'));
  } else { alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Demo)');resetEntryArea(); }
}

// ===== REPORT SYSTEM =====
let reportCache = {};

function buildReportShell(containerId) {
  const c = document.getElementById(containerId);
  if (!c) return;
  c.innerHTML = `
  <!-- Report Tabs -->
  <div class="in-tabs mb-24" id="${containerId}-tabs">
    <button class="in-tab active" onclick="switchRptTab('${containerId}','entries')">üìù ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="in-tab" onclick="switchRptTab('${containerId}','payments')">üí≥ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
    <button class="in-tab" onclick="switchRptTab('${containerId}','customer')">üë§ ‡∏£‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    <button class="in-tab" onclick="switchRptTab('${containerId}','outstanding')">‚ö†Ô∏è ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</button>
  </div>

  <!-- Filter Bar -->
  <div class="card mb-16" id="${containerId}-filter"><div class="card-body" style="padding:12px 20px">
    <div class="flex items-c gap-8 mb-12" style="flex-wrap:wrap">
      <div style="font-size:12px;font-weight:600;color:var(--text-s)">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°:</div>
      <button class="btn btn-sm rpt-mode-btn active" data-mode="month" onclick="switchRptMode('${containerId}','month')">üìÖ ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button class="btn btn-sm rpt-mode-btn" data-mode="daterange" onclick="switchRptMode('${containerId}','daterange')">üìÜ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
    <div class="flex items-c gap-12" style="flex-wrap:wrap">
      <div class="form-group rpt-filter-month" style="margin:0;flex:1;min-width:150px">
        <label class="form-label" style="font-size:11px;margin-bottom:4px">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label>
        <select class="form-select" id="${containerId}-month" onchange="loadReport('${containerId}')" style="font-size:13px"></select>
      </div>
      <div class="rpt-filter-date" style="display:none;flex:2;min-width:300px">
        <div class="flex items-c gap-8">
          <div class="form-group" style="margin:0;flex:1">
            <label class="form-label" style="font-size:11px;margin-bottom:4px">üìÜ ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" class="form-input" id="${containerId}-datefrom" style="font-size:13px" />
          </div>
          <div style="padding-top:14px;color:var(--text-m)">‚Üí</div>
          <div class="form-group" style="margin:0;flex:1">
            <label class="form-label" style="font-size:11px;margin-bottom:4px">üìÜ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" class="form-input" id="${containerId}-dateto" style="font-size:13px" />
          </div>
        </div>
      </div>
      <div class="form-group" style="margin:0;flex:1;min-width:150px;display:none" id="${containerId}-cust-wrap">
        <label class="form-label" style="font-size:11px;margin-bottom:4px">üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <select class="form-select" id="${containerId}-cust" onchange="loadReport('${containerId}')" style="font-size:13px"><option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢ ‚Äî</option></select>
      </div>
      <div style="padding-top:16px"><button class="btn btn-p btn-sm" onclick="loadReport('${containerId}')">üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div>
    </div>
  </div></div>

  <!-- Stats -->
  <div class="stats mb-24" id="${containerId}-stats" style="display:none"></div>

  <!-- Report Body -->
  <div id="${containerId}-body" style="text-align:center;padding:40px;color:var(--text-m)">
    <div style="font-size:32px;margin-bottom:8px">üìä</div>
    <div>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  </div>`;

  // Populate month dropdown
  populateReportMonths(containerId);
  // Populate customer dropdown
  populateReportCusts(containerId);
}

function populateReportMonths(cid) {
  const sel = document.getElementById(cid + '-month');
  if (!sel) return;
  sel.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const m = d.getMonth();
    const y = d.getFullYear() + 543;
    const short = THAI_MONTHS[m] + ' ' + String(y).slice(-2);
    const full = THAI_MONTHS_FULL[m] + ' ' + y;
    const opt = document.createElement('option');
    opt.value = short; opt.textContent = full;
    if (i === 0) opt.selected = true;
    sel.appendChild(opt);
  }
}

function populateReportCusts(cid) {
  const sel = document.getElementById(cid + '-cust');
  if (!sel) return;
  sel.innerHTML = '<option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢ ‚Äî</option>';
  allCustomers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.code; opt.textContent = c.code + ' ' + c.name;
    sel.appendChild(opt);
  });
}

let currentRptTab = {};
let currentRptMode = {}; // 'month' or 'daterange'

function switchRptMode(cid, mode) {
  currentRptMode[cid] = mode;
  const filter = document.getElementById(cid + '-filter');
  if (!filter) return;
  filter.querySelectorAll('.rpt-mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
  filter.querySelectorAll('.rpt-filter-month').forEach(el => el.style.display = mode === 'month' ? '' : 'none');
  filter.querySelectorAll('.rpt-filter-date').forEach(el => el.style.display = mode === 'daterange' ? 'flex' : 'none');
  // Set default dates if empty
  if (mode === 'daterange') {
    const from = document.getElementById(cid + '-datefrom');
    const to = document.getElementById(cid + '-dateto');
    if (from && !from.value) {
      const d = new Date(); d.setDate(1); // first of current month
      from.value = d.toISOString().split('T')[0];
    }
    if (to && !to.value) {
      to.value = new Date().toISOString().split('T')[0];
    }
  }
}

function switchRptTab(cid, tab) {
  currentRptTab[cid] = tab;
  const tabs = document.querySelectorAll('#' + cid + '-tabs .in-tab');
  const labels = ['entries','payments','customer','outstanding'];
  tabs.forEach((t, i) => t.classList.toggle('active', labels[i] === tab));
  // Show/hide customer filter
  const cw = document.getElementById(cid + '-cust-wrap');
  if (cw) cw.style.display = tab === 'customer' ? 'block' : 'none';
  loadReport(cid);
}

async function loadReport(cid) {
  const tab = currentRptTab[cid] || 'entries';
  const mode = currentRptMode[cid] || 'month';
  const month = mode === 'month' ? (document.getElementById(cid + '-month')?.value || '') : '';
  const dateFrom = mode === 'daterange' ? (document.getElementById(cid + '-datefrom')?.value || '') : '';
  const dateTo = mode === 'daterange' ? (document.getElementById(cid + '-dateto')?.value || '') : '';
  const cust = document.getElementById(cid + '-cust')?.value || '';
  const body = document.getElementById(cid + '-body');
  const stats = document.getElementById(cid + '-stats');
  if (!body) return;
  body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</div>';
  if (stats) stats.style.display = 'none';

  const params = { type: tab, month, dateFrom, dateTo, filterMode: mode, custCode: cust };
  const data = await apiGet('getReport', params);
  if (!data || data.error) {
    body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--red)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (data?.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏') + '</div>';
    return;
  }
  reportCache[cid] = { tab, data, month, cust };

  switch (tab) {
    case 'entries': renderRptEntries(cid, data); break;
    case 'payments': renderRptPayments(cid, data); break;
    case 'customer': renderRptCustomer(cid, data); break;
    case 'outstanding': renderRptOutstanding(cid, data); break;
  }
}

// ===== RENDER: ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å =====
function renderRptEntries(cid, d) {
  const stats = document.getElementById(cid + '-stats');
  const body = document.getElementById(cid + '-body');
  if (stats) {
    stats.style.display = '';
    stats.innerHTML = `
      <div class="stat"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-val" style="color:var(--blue)">${d.totalEntries}</div></div>
      <div class="stat"><div class="stat-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-val" style="color:var(--accent)">${d.todayCount}</div></div>
      <div class="stat"><div class="stat-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö</div><div class="stat-val" style="color:var(--blue)">${fmtBaht(d.totalBilled)}</div></div>
      <div class="stat"><div class="stat-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div><div class="stat-val" style="color:var(--green)">${fmtBaht(d.totalPaid)}</div></div>
      <div class="stat"><div class="stat-label">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div><div class="stat-val" style="color:var(--red)">${fmtBaht(d.totalOutstanding)}</div></div>`;
  }
  if (!d.customers || !d.customers.length) {
    body.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;padding:40px;color:var(--text-m)">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div></div>';
    return;
  }
  // Today section
  let html = '';
  if (d.todayEntries && d.todayEntries.length) {
    html += '<div class="card mb-16"><div class="card-head"><div class="card-t">üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (' + d.today + ')</div></div><div class="tbl-w"><table><thead><tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>';
    d.todayEntries.forEach(e => {
      html += '<tr><td class="mono">' + e.code + '</td><td><strong>' + e.name + '</strong></td><td>' + e.month + '</td><td class="text-r mono" style="font-weight:600">' + fmtBaht(e.total) + '</td><td>' + statusBadge(e.status) + '</td></tr>';
    });
    html += '</tbody></table></div></div>';
  }
  // All customers
  html += '<div class="card"><div class="card-head"><div class="card-t">üìä ‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî ' + (d.month || '‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') + '</div></div><div class="tbl-w"><table><thead><tr><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="text-r">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th class="text-r">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th class="text-r">‡∏†‡∏û 30</th><th class="text-r">‡∏†‡∏á‡∏î 3,53</th><th class="text-r">‡∏†‡∏ò 40</th><th class="text-r">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th><th class="text-r" style="font-weight:700">‡∏£‡∏ß‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>';
  let gt = 0;
  d.customers.forEach(c => {
    c.months.forEach((m, i) => {
      const others = (m.pnd90||0)+(m.pnd94||0)+(m.audit||0)+(m.pnd51||0)+(m.pnd50||0)+(m.other||0);
      html += '<tr>' + (i === 0 ? '<td rowspan="' + c.months.length + '"><strong>' + c.name + '</strong><br><span class="mono" style="font-size:11px;color:var(--text-m)">' + c.code + '</span></td>' : '') +
        '<td>' + m.month + '</td><td class="text-r mono">' + (m.accounting||0).toLocaleString() + '</td><td class="text-r mono">' + (m.vat||0).toLocaleString() + '</td><td class="text-r mono">' + (m.wht||0).toLocaleString() + '</td><td class="text-r mono">' + (m.sbt||0).toLocaleString() + '</td><td class="text-r mono">' + (others||0).toLocaleString() + '</td><td class="text-r mono" style="font-weight:700">' + (m.total||0).toLocaleString() + '</td><td>' + statusBadge(m.status) + '</td></tr>';
    });
    gt += c.grandTotal;
  });
  html += '</tbody><tfoot><tr style="background:var(--surface-alt);font-weight:700"><td colspan="7">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="text-r mono" style="color:var(--accent)">' + fmtBaht(gt) + '</td><td></td></tr></tfoot></table></div></div>';
  body.innerHTML = html;
}

// ===== RENDER: ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ =====
function renderRptPayments(cid, d) {
  const stats = document.getElementById(cid + '-stats');
  const body = document.getElementById(cid + '-body');
  if (stats) {
    stats.style.display = '';
    stats.innerHTML = `
      <div class="stat"><div class="stat-label">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="stat-val" style="color:var(--orange)">${d.pendingCount}</div><div class="stat-sub">${fmtBaht(d.pendingTotal)}</div></div>
      <div class="stat"><div class="stat-label">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div><div class="stat-val" style="color:var(--green)">${d.approvedCount}</div><div class="stat-sub">${fmtBaht(d.approvedTotal)}</div></div>
      <div class="stat"><div class="stat-label">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</div><div class="stat-val" style="color:var(--red)">${d.rejectedCount}</div><div class="stat-sub">${fmtBaht(d.rejectedTotal)}</div></div>`;
  }
  function payTable(title, icon, items, color) {
    if (!items || !items.length) return '<div class="card mb-16"><div class="card-head"><div class="card-t">' + icon + ' ' + title + '</div></div><div class="card-body" style="text-align:center;padding:24px;color:var(--text-m)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>';
    let h = '<div class="card mb-16"><div class="card-head"><div class="card-t">' + icon + ' ' + title + ' <span class="badge b-' + color + '" style="margin-left:8px">' + items.length + '</span></div></div><div class="tbl-w"><table><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th></tr></thead><tbody>';
    items.forEach(p => {
      h += '<tr><td class="mono" style="font-size:12px">' + (p.payNo||'‚Äî') + '</td><td><strong>' + (p.custName||'‚Äî') + '</strong><br><span class="mono" style="font-size:11px;color:var(--text-m)">' + (p.custCode||'') + '</span></td><td>' + (p.channel||'‚Äî') + (p.bank && p.bank !== '‚Äî' ? '<br><span style="font-size:11px;color:var(--text-m)">' + p.bank + '</span>' : '') + '</td><td class="mono">' + (p.date||'‚Äî') + '</td><td class="text-r mono" style="font-weight:700">' + fmtBaht(p.amount) + '</td><td>' + (p.staff||'‚Äî') + '</td></tr>';
    });
    let total = items.reduce((s, p) => s + (p.amount||0), 0);
    h += '</tbody><tfoot><tr style="background:var(--surface-alt);font-weight:700"><td colspan="4">‡∏£‡∏ß‡∏° ' + items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="text-r mono" style="color:var(--accent)">' + fmtBaht(total) + '</td><td></td></tr></tfoot></table></div></div>';
    return h;
  }
  body.innerHTML = payTable('‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥','‚è≥', d.pending, 'orange') + payTable('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß','‚úÖ', d.approved, 'green') + payTable('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò','‚ùå', d.rejected, 'red');
}

// ===== RENDER: ‡∏£‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ =====
function renderRptCustomer(cid, d) {
  const stats = document.getElementById(cid + '-stats');
  const body = document.getElementById(cid + '-body');
  if (stats) stats.style.display = 'none';

  if (!d.customers || !d.customers.length) {
    body.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;padding:40px;color:var(--text-m)">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div></div>';
    return;
  }
  let html = '';
  d.customers.forEach(c => {
    const outstanding = c.totalBilled - c.totalPaid;
    const paidPct = c.totalBilled > 0 ? Math.round(c.totalPaid / c.totalBilled * 100) : 0;
    html += '<div class="card mb-16"><div class="card-head"><div class="card-t">üë§ ' + c.name + ' <span class="mono" style="font-size:12px;color:var(--text-m);margin-left:8px">' + c.code + '</span></div><div style="font-size:13px"><span style="color:var(--green);font-weight:600">‡∏ä‡∏≥‡∏£‡∏∞ ' + fmtBaht(c.totalPaid) + '</span> / <span style="font-weight:600">' + fmtBaht(c.totalBilled) + '</span>' + (outstanding > 0 ? ' ¬∑ <span style="color:var(--red);font-weight:600">‡∏Ñ‡πâ‡∏≤‡∏á ' + fmtBaht(outstanding) + '</span>' : '') + '</div></div>';
    // Progress bar
    html += '<div style="padding:0 24px 12px"><div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="height:100%;width:' + paidPct + '%;background:var(--green);border-radius:3px;transition:width .3s"></div></div><div style="font-size:11px;color:var(--text-m);margin-top:4px">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ' + paidPct + '%</div></div>';
    // Items table
    html += '<div class="tbl-w"><table><thead><tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞</th></tr></thead><tbody>';
    if (c.items && c.items.length) {
      c.items.forEach(it => {
        const isPaid = it.paid === true;
        html += '<tr><td>' + it.month + '</td><td>' + it.service + '</td><td class="text-r mono" style="font-weight:600">' + fmtBaht(it.amount) + '</td><td>' + (isPaid ? '<span class="badge b-green"><span class="dot"></span>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>' : '<span class="badge b-red"><span class="dot"></span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</span>') + '</td></tr>';
      });
    } else {
      html += '<tr><td colspan="4" style="text-align:center;color:var(--text-m);padding:16px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
    }
    html += '</tbody></table></div></div>';
  });
  body.innerHTML = html;
}

// ===== RENDER: ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ =====
function renderRptOutstanding(cid, d) {
  const stats = document.getElementById(cid + '-stats');
  const body = document.getElementById(cid + '-body');
  if (stats) {
    stats.style.display = '';
    stats.innerHTML = `
      <div class="stat"><div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div><div class="stat-val" style="color:var(--red)">${d.totalCustomers}</div><div class="stat-sub">‡∏£‡∏≤‡∏¢</div></div>
      <div class="stat"><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-val" style="color:var(--red)">${fmtBaht(d.grandTotal)}</div></div>
      <div class="stat"><div class="stat-label">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="stat-val" style="color:var(--orange)">${fmtBaht(d.grandPending)}</div></div>
      <div class="stat"><div class="stat-label">‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="stat-val" style="color:var(--red);font-size:24px">${fmtBaht(d.netOutstanding)}</div></div>`;
  }
  if (!d.customers || !d.customers.length) {
    body.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;padding:40px;color:var(--green)"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div></div>';
    return;
  }
  let html = '<div class="card"><div class="card-head"><div class="card-t">‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div></div><div class="tbl-w"><table><thead><tr><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</th><th class="text-r">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏ß‡∏°</th><th class="text-r">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th><th class="text-r" style="font-weight:700">‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th></tr></thead><tbody>';
  d.customers.forEach(c => {
    const net = c.totalOutstanding - c.pendingPayment;
    html += '<tr><td><strong>' + c.name + '</strong><br><span class="mono" style="font-size:11px;color:var(--text-m)">' + c.code + '</span></td><td class="text-r"><span class="badge b-red">' + c.monthCount + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></td><td class="text-r mono" style="font-weight:600;color:var(--red)">' + fmtBaht(c.totalOutstanding) + '</td><td class="text-r mono" style="color:var(--orange)">' + (c.pendingPayment > 0 ? fmtBaht(c.pendingPayment) : '‚Äî') + '</td><td class="text-r mono" style="font-weight:700;color:var(--red)">' + fmtBaht(net) + '</td></tr>';
    // Expandable detail
    if (c.monthDetails && c.monthDetails.length) {
      html += '<tr><td colspan="5" style="padding:0"><details style="padding:8px 16px"><summary style="cursor:pointer;font-size:12px;color:var(--text-m);padding:4px 0">üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (' + c.monthDetails.length + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</summary><table style="width:100%;margin:8px 0"><thead><tr style="font-size:11px;color:var(--text-m)"><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="text-r">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead><tbody>';
      c.monthDetails.forEach(m => {
        if (m.items && m.items.length) {
          m.items.forEach((it, idx) => {
            html += '<tr>' + (idx === 0 ? '<td rowspan="' + m.items.length + '" style="font-weight:600">' + m.month + '</td>' : '') + '<td>' + it.serviceLabel + '</td><td class="text-r mono">' + (it.amount||0).toLocaleString() + '</td></tr>';
          });
        } else {
          html += '<tr><td style="font-weight:600">' + m.month + '</td><td>‚Äî</td><td class="text-r mono" style="font-weight:700">' + (m.total||0).toLocaleString() + '</td></tr>';
        }
      });
      html += '</tbody></table></details></td></tr>';
    }
  });
  html += '</tbody><tfoot><tr style="background:var(--surface-alt);font-weight:700"><td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (' + d.totalCustomers + ' ‡∏£‡∏≤‡∏¢)</td><td></td><td class="text-r mono" style="color:var(--red)">' + fmtBaht(d.grandTotal) + '</td><td class="text-r mono" style="color:var(--orange)">' + fmtBaht(d.grandPending) + '</td><td class="text-r mono" style="color:var(--red);font-size:16px">' + fmtBaht(d.netOutstanding) + '</td></tr></tfoot></table></div></div>';
  body.innerHTML = html;
}

// ===== PDF EXPORT =====
async function exportReportPDF(role) {
  const cid = 'report-area-' + role;
  const body = document.getElementById(cid + '-body');
  if (!body || body.textContent.trim().includes('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°')) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
    return;
  }
  // Load html2pdf if not loaded
  if (!window.html2pdf) {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    document.head.appendChild(s);
    await new Promise(r => s.onload = r);
  }
  const tab = currentRptTab[cid] || 'entries';
  const tabNames = { entries:'‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', payments:'‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', customer:'‡∏£‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', outstanding:'‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' };
  const filename = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô-' + (tabNames[tab]||tab) + '-' + new Date().toISOString().slice(0,10) + '.pdf';

  // Create printable wrapper with proper styling
  const wrap = document.createElement('div');
  wrap.style.cssText = 'width:100%;font-family:"Sarabun",sans-serif;font-size:11px;color:#222;line-height:1.4';
  
  // Header
  wrap.innerHTML = '<div style="text-align:center;margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid #333"><h2 style="margin:0;font-size:18px;font-weight:700">‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2><div style="color:#666;margin-top:4px;font-size:11px">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' + (tabNames[tab]||'') + ' ¬∑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + new Date().toLocaleDateString('th-TH') + '</div></div>';
  
  // Clone stats if visible ‚Äî style as inline grid
  const statsEl = document.getElementById(cid + '-stats');
  if (statsEl && statsEl.style.display !== 'none') {
    const statsClone = statsEl.cloneNode(true);
    // Flatten stat cards into a simple row
    statsClone.style.cssText = 'display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap';
    statsClone.querySelectorAll('.card, [class*="stat"]').forEach(c => {
      c.style.cssText = 'flex:1;min-width:120px;padding:10px 14px;border:1px solid #ddd;border-radius:6px;background:#fafaf8';
    });
    wrap.appendChild(statsClone);
  }
  
  // Clone body and fix table styles for PDF
  const bodyClone = body.cloneNode(true);
  
  // Style all tables for clean PDF output
  bodyClone.querySelectorAll('table').forEach(tbl => {
    tbl.style.cssText = 'width:100%;border-collapse:collapse;font-size:10px;margin-bottom:8px';
    tbl.querySelectorAll('th').forEach(th => {
      th.style.cssText = 'padding:6px 8px;border:1px solid #ccc;background:#f0ece4;font-weight:600;text-align:left;font-size:10px;white-space:nowrap';
    });
    tbl.querySelectorAll('td').forEach(td => {
      td.style.cssText = 'padding:5px 8px;border:1px solid #ddd;font-size:10px;vertical-align:top';
    });
    // Alternate row coloring
    tbl.querySelectorAll('tr').forEach((tr, i) => {
      if (i > 0 && i % 2 === 0) {
        tr.querySelectorAll('td').forEach(td => td.style.background = '#fafaf8');
      }
    });
  });
  
  // Fix card borders for PDF
  bodyClone.querySelectorAll('.card').forEach(c => {
    c.style.cssText = 'border:1px solid #ddd;border-radius:6px;margin-bottom:12px;overflow:hidden';
  });
  bodyClone.querySelectorAll('.card-head, .card-t').forEach(h => {
    h.style.cssText = 'padding:8px 12px;font-weight:600;font-size:12px;background:#f0ece4;border-bottom:1px solid #ddd';
  });
  
  // Add page-break-inside: avoid to key elements
  bodyClone.querySelectorAll('.card, .hb, [class*="stat"]').forEach(el => {
    el.style.pageBreakInside = 'avoid';
  });
  // Allow table rows to break
  bodyClone.querySelectorAll('tr').forEach(tr => {
    tr.style.pageBreakInside = 'avoid';
  });
  
  wrap.appendChild(bodyClone);

  const opt = {
    margin: [8, 8, 8, 8],
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: 1100 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
    pagebreak: { mode: ['css'], avoid: ['tr', '.card'] }
  };
  
  // Show loading
  const btn = document.querySelector('[onclick*="exportReportPDF"]');
  const origText = btn ? btn.innerHTML : '';
  if (btn) { btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...'; btn.disabled = true; }
  
  try {
    await html2pdf().set(opt).from(wrap).save();
  } catch(e) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
  }
  if (btn) { btn.innerHTML = origText; btn.disabled = false; }
}

// ===== INIT REPORTS ON PAGE NAVIGATE =====
const origGoPage = goPage;
goPage = function(id) {
  origGoPage(id);
  if (id === 'mgr-report' && !document.getElementById('report-area-mgr-tabs')) {
    buildReportShell('report-area-mgr');
    loadReport('report-area-mgr');
  }
  if (id === 'staff-report' && !document.getElementById('report-area-staff-tabs')) {
    buildReportShell('report-area-staff');
    loadReport('report-area-staff');
  }
  if (id === 'staff-history') loadHistory();
  if (id === 'mgr-approve') loadApprove();
  if (id === 'staff-submit') loadStaffSubmit();
  if (id === 'staff-inv') loadStaffInvoices();
  if (id === 'staff-collect' && collectCustCode) loadCollectItems(collectCustCode, collectCustName);
};

function goToCollect() {
  if (invCustCode) {
    collectCustCode = invCustCode;
    collectCustName = invCustName;
  }
  goPage('staff-collect');
  if (collectCustCode) loadCollectItems(collectCustCode, collectCustName);
}

// ===== LOAD: History =====
async function loadHistory() {
  const tb = document.getElementById('staff-hist-tb');
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
  const data = await apiGet('getPayments');
  if (!data || data.error || !data.length) {
    tb.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-m)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</td></tr>';
    return;
  }
  data.sort((a, b) => (b.date||'').localeCompare(a.date||''));
  tb.innerHTML = data.map(p => '<tr><td class="mono">' + (p.date||'‚Äî') + '</td><td><strong>' + (p.custName||'‚Äî') + '</strong></td><td class="mono" style="font-size:12px">' + (p.invNo||'‚Äî') + '</td><td>' + (p.channel||'‚Äî') + '</td><td class="text-r mono" style="font-weight:600">' + fmtBaht(p.amount) + '</td><td>' + statusBadge(p.status) + '</td></tr>').join('');
}

// ===== LOAD: MGR Approve Page =====
async function loadApprove() {
  const pl = document.getElementById('approve-pending-list');
  const dl = document.getElementById('approve-done-list');
  if (pl) pl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  if (dl) dl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

  const data = await apiGet('getPayments');
  if (!data || data.error) {
    if (pl) pl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--red)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    return;
  }

  const pending = data.filter(p => p.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  const approved = data.filter(p => p.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  const rejected = data.filter(p => p.status === '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò');

  // Update badge
  const badge = document.getElementById('nav-approve-count');
  if (badge) { if (pending.length > 0) { badge.textContent = pending.length; badge.style.display = ''; } else { badge.style.display = 'none'; } }

  // Pending
  if (pl) {
    if (!pending.length) pl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--green)"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    else pl.innerHTML = pending.map(p => renderApproveCard(p, 'pending')).join('');
  }
  // Approved
  if (dl) {
    if (!approved.length) dl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-m)"><div style="font-size:32px;margin-bottom:8px">üì≠</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    else dl.innerHTML = approved.map(p => renderApproveCard(p, 'approved')).join('');
  }
  // Rejected
  const rl = document.querySelector('#approve-reject > div');
  if (rl) {
    if (!rejected.length) rl.innerHTML = '<div style="font-size:32px;margin-bottom:12px">üì≠</div><div style="font-size:14px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    else rl.outerHTML = rejected.map(p => renderApproveCard(p, 'rejected')).join('');
  }
}

// Store pending payments data for approve actions
let approveData = {};
function renderApproveCard(p, type) {
  const colors = { pending: 'var(--orange)', approved: 'var(--green)', rejected: 'var(--red)' };
  const labels = { pending: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', approved: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', rejected: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
  const badgeClass = { pending: 'b-orange', approved: 'b-green', rejected: 'b-red' };
  const uid = 'ap-' + (p.payNo||'').replace(/[^a-zA-Z0-9-]/g,'');
  if (type === 'pending') approveData[uid] = p;
  let html = '<div class="card mb-12" style="border-left:4px solid ' + colors[type] + '">';
  html += '<div class="card-body" style="padding:16px 20px"><div class="flex items-c jc-b" style="flex-wrap:wrap;gap:8px">';
  html += '<div><div style="font-weight:700;font-size:15px">' + esc(p.custName||'‚Äî') + ' <span class="mono" style="font-size:12px;color:var(--text-m)">' + esc(p.custCode||'') + '</span></div>';
  html += '<div style="font-size:13px;color:var(--text-m);margin-top:2px">' + esc(p.payNo||'‚Äî') + ' ¬∑ ' + esc(p.channel||'‚Äî') + (p.bank && p.bank !== '‚Äî' ? ' ¬∑ ' + esc(p.bank) : '') + ' ¬∑ ' + esc(p.date||'‚Äî') + ' ¬∑ ' + esc(p.staff||'‚Äî') + '</div></div>';
  html += '<div class="flex items-c gap-12"><div class="mono" style="font-size:20px;font-weight:700;color:' + colors[type] + '">' + fmtBaht(p.amount) + '</div>';
  html += '<span class="badge ' + badgeClass[type] + '"><span class="dot"></span>' + labels[type] + '</span></div></div>';
  if (type === 'pending') {
    html += '<div class="flex gap-8" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">';
    html += '<button class="btn btn-p btn-sm" onclick="doApprove(\'' + uid + '\')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>';
    html += '<button class="btn btn-danger btn-sm" onclick="doReject(\'' + uid + '\')">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>';
    html += '</div>';
  }
  if (type === 'approved' && p.approvedDate) html += '<div style="margin-top:8px;font-size:11px;color:var(--text-m)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + esc(p.approvedDate) + (p.approvedBy ? ' ‡πÇ‡∏î‡∏¢ ' + esc(p.approvedBy) : '') + '</div>';
  html += '</div></div>';
  return html;
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

async function doApprove(uid) {
  const p = approveData[uid];
  if (!p) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?\n\n' + p.payNo + ' ¬∑ ' + p.custName + ' ¬∑ ' + fmtBaht(p.amount))) return;
  const name = currentUser ? currentUser.name : '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
  const r = await apiPost('approvePayment', {
    rowIndex: p._rowIndex, payNo: p.payNo, invNo: p.invNo,
    custCode: p.custCode, custName: p.custName,
    amount: p.amount, channel: p.channel, bank: p.bank, approvedBy: name
  });
  if (r && r.success) {
    alert('‚úÖ ' + r.message);
    loadApprove();
    loadDashboard('mgr');
  } else {
    alert('‚ùå ' + (r?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ'));
  }
}

async function doReject(uid) {
  const p = approveData[uid];
  if (!p) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
  const reason = prompt('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:');
  if (reason === null) return;
  const r = await apiPost('rejectPayment', { rowIndex: p._rowIndex, reason: reason || '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' });
  if (r && r.success) {
    alert('‚úÖ ' + r.message);
    loadApprove();
    loadDashboard('mgr');
  } else {
    alert('‚ùå ' + (r?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ'));
  }
}

// ===== LOAD: Staff Submit Page =====
async function loadStaffSubmit() {
  const pl = document.getElementById('staff-submit-pending');
  const dl = document.getElementById('staff-submit-done');
  if (pl) pl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  if (dl) dl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

  const data = await apiGet('getPayments');
  if (!data || data.error) {
    if (pl) pl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--red)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    return;
  }

  const pending = data.filter(p => p.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  const approved = data.filter(p => p.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  const rejected = data.filter(p => p.status === '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò');

  // Update badge
  const badge = document.getElementById('nav-submit-count');
  if (badge) { if (pending.length > 0) { badge.textContent = pending.length; badge.style.display = ''; } else { badge.style.display = 'none'; } }

  function renderSubmitCard(p, type) {
    const colors = { pending: 'var(--orange)', approved: 'var(--green)', rejected: 'var(--red)' };
    const labels = { pending: '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', approved: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', rejected: '‚ùå ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' };
    const badgeClass = { pending: 'b-orange', approved: 'b-green', rejected: 'b-red' };
    let h = '<div class="card mb-12" style="border-left:4px solid ' + colors[type] + '"><div class="card-body" style="padding:14px 20px">';
    h += '<div class="flex items-c jc-b" style="flex-wrap:wrap;gap:8px">';
    h += '<div><div style="font-weight:600">' + (p.custName||'‚Äî') + '</div><div style="font-size:12px;color:var(--text-m)">' + (p.payNo||'') + ' ¬∑ ' + (p.channel||'') + ' ¬∑ ' + (p.date||'') + '</div></div>';
    h += '<div class="flex items-c gap-8"><span class="mono" style="font-size:18px;font-weight:700">' + fmtBaht(p.amount) + '</span><span class="badge ' + badgeClass[type] + '"><span class="dot"></span>' + labels[type] + '</span></div>';
    h += '</div>';
    if (type === 'rejected' && p.note) h += '<div style="margin-top:8px;padding:8px 12px;background:var(--red-l,#fff0f0);border-radius:var(--r);font-size:12px;color:var(--red)">üí¨ ' + p.note + '</div>';
    if (type === 'approved' && p.approvedDate) h += '<div style="margin-top:4px;font-size:11px;color:var(--text-m)">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ' + p.approvedDate + ' ‡πÇ‡∏î‡∏¢ ' + (p.approvedBy||'') + '</div>';
    h += '</div></div>';
    return h;
  }

  if (pl) {
    if (!pending.length) pl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--green)"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    else pl.innerHTML = pending.map(p => renderSubmitCard(p, 'pending')).join('');
  }
  if (dl) {
    if (!approved.length) dl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-m)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>';
    else dl.innerHTML = approved.map(p => renderSubmitCard(p, 'approved')).join('');
  }
  const rl = document.querySelector('#submit-return > div');
  if (rl) {
    if (!rejected.length) rl.innerHTML = '<div style="font-size:32px;margin-bottom:12px">‚úÖ</div><div style="font-size:14px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</div>';
    else rl.outerHTML = '<div>' + rejected.map(p => renderSubmitCard(p, 'rejected')).join('') + '</div>';
  }
}

// ===== LOAD: Staff Invoices =====
async function loadStaffInvoices() {
  // Load customer list into inv-cust-tbody
  const tb = document.getElementById('inv-cust-tbody');
  if (tb && allCustomers.length) {
    tb.innerHTML = allCustomers.map((c, idx) => {
      const ow = c.outstanding || 0;
      const mo = c.monthsOwed || 0;
      const owHtml = ow > 0 ? '<span style="color:var(--red);font-weight:600">' + fmtBaht(ow) + '</span>' : '<span style="color:var(--text-m)">‚Äî</span>';
      const moHtml = mo > 0 ? '<span class="badge b-red">' + mo + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>' : '<span style="color:var(--text-m)">‚Äî</span>';
      return '<tr class="inv-cust-row" data-idx="' + idx + '" onclick="selectInvCustByIdx(' + idx + ')" style="cursor:pointer"><td style="text-align:center;font-size:18px">üìÑ</td><td class="mono">' + esc(c.code) + '</td><td><strong>' + esc(c.name) + '</strong></td><td class="text-r">' + owHtml + '</td><td class="text-r">' + moHtml + '</td><td>' + statusBadge(c.status || '‡∏õ‡∏Å‡∏ï‡∏¥') + '</td></tr>';
    }).join('');
  } else if (tb) {
    tb.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-m)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</td></tr>';
  }
}
function selectInvCustByIdx(idx) {
  const c = allCustomers[idx];
  if (c) selectInvCust(c.code, c.name);
}

// ===== LOAD: Invoice Items (unpaid items for invoice) =====
let invItemsCache = [];
async function loadInvItems(custCode, custName) {
  const tb = document.getElementById('inv-detail-tbody');
  const totalEl = document.getElementById('inv-list-total');
  const infoEl = document.getElementById('inv-sel-info');
  if (!tb) return;
  tb.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:var(--text-m)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

  const data = await apiGet('getUnpaidItems', { custCode });
  if (!data || data.error) {
    tb.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:var(--red)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
    return;
  }
  const unpaid = data.filter(it => !it.paid);
  invItemsCache = unpaid; // Store for generateInvPreview (include pending too - they're still outstanding)
  
  if (!unpaid.length) {
    tb.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--green)">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td></tr>';
    if (totalEl) totalEl.textContent = '‡∏ø0';
    if (infoEl) infoEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞';
    return;
  }
  let total = 0, num = 0;
  tb.innerHTML = unpaid.map(it => {
    num++; total += it.amount;
    const badge = it.pending ? '<span class="badge b-orange" style="font-size:10px"><span class="dot"></span>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>' : '';
    return '<tr><td>' + num + '</td><td>' + it.month + '</td><td>' + it.serviceLabel + ' ' + badge + '</td><td class="text-r mono" style="font-weight:600">' + fmtBaht(it.amount) + '</td></tr>';
  }).join('');
  if (totalEl) totalEl.textContent = fmtBaht(total);
  if (infoEl) infoEl.textContent = unpaid.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ ' + [...new Set(unpaid.map(it=>it.month))].length + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ¬∑ ‡∏£‡∏ß‡∏° ' + fmtBaht(total);
}

// ===== INVOICE FLOW =====
let invCustCode='',invCustName='';
function setInvFlow(s){const f=[document.getElementById('inv-flow-1'),document.getElementById('inv-flow-2'),document.getElementById('inv-flow-3')];if(!f[0])return;f.forEach(x=>x.className='flow-s');if(s>=1)f[0].className=s===1?'flow-s active':'flow-s done';if(s>=2)f[1].className=s===2?'flow-s active':'flow-s done';if(s>=3)f[2].className='flow-s active'}
function filterInvCust(v){document.querySelectorAll('.inv-cust-row').forEach(r=>{r.style.display=r.textContent.toLowerCase().includes(v.toLowerCase())?'':'none'})}
function selectInvCust(code,name){invCustCode=code;invCustName=name;document.getElementById('inv-step-select').style.display='none';document.getElementById('inv-step-list').style.display='block';document.getElementById('inv-step-print').style.display='none';document.getElementById('inv-sel-name').textContent=code+' ‚Äî '+name;document.getElementById('inv-sel-info').textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞...';setInvFlow(2);loadInvItems(code,name)}
function backToInvSelect(){document.getElementById('inv-step-select').style.display='block';document.getElementById('inv-step-list').style.display='none';document.getElementById('inv-step-print').style.display='none';document.getElementById('inv-cust-search').value='';filterInvCust('');setInvFlow(1)}
function backToInvList(){document.getElementById('inv-step-select').style.display='none';document.getElementById('inv-step-list').style.display='block';document.getElementById('inv-step-print').style.display='none';setInvFlow(2)}
function generateInvPreview(){const items=invItemsCache||[];const tb=document.getElementById('inv-print-body');tb.innerHTML='';let t=0;items.forEach((it,i)=>{t+=it.amount;const tr=document.createElement('tr');tr.innerHTML='<td>'+(i+1)+'</td><td>'+it.serviceLabel+'</td><td>'+it.month+'</td><td class="text-r mono">'+fmtBaht(it.amount)+'</td>';tb.appendChild(tr)});document.getElementById('inv-print-total').textContent=fmtBaht(t);document.getElementById('inv-print-total-text').textContent='('+items.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)';document.getElementById('inv-print-cust').textContent=invCustName;document.getElementById('inv-print-code').textContent='‡∏£‡∏´‡∏±‡∏™: '+invCustCode;document.getElementById('inv-print-no').textContent='INV-'+(new Date().getFullYear()+543)+'-'+String(Math.floor(Math.random()*900+100)).padStart(4,'0');
// Bank info from settings
const bankName=appSettings['‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£']||appSettings['‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£']||'';const acctNo=appSettings['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ']||appSettings['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ']||'';const acctName=appSettings['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ']||appSettings['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']||'‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';const el1=document.getElementById('inv-qr-acct-name');if(el1)el1.textContent='‡∏ö‡∏±‡∏ç‡∏ä‡∏µ '+acctName;const el2=document.getElementById('inv-bank-info');if(el2)el2.textContent=(bankName?'‡∏ò.'+bankName+' ':'')+(acctNo||'');const el3=document.getElementById('inv-bank-name');if(el3)el3.textContent='‡∏ä‡∏∑‡πà‡∏≠: '+acctName;
// Date
const td=new Date();const thM=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];const dateStr=td.getDate()+' '+thM[td.getMonth()]+' '+(td.getFullYear()+543);document.getElementById('inv-print-date').textContent=dateStr;
// Set due date (15 days from today)
const due=new Date(td);due.setDate(due.getDate()+15);const dueStr=due.getDate()+' '+thM[due.getMonth()]+' '+(due.getFullYear()+543);document.getElementById('inv-print-due').textContent=dueStr;
document.getElementById('inv-step-select').style.display='none';document.getElementById('inv-step-list').style.display='none';document.getElementById('inv-step-print').style.display='block';setInvFlow(3);window.scrollTo({top:0,behavior:'smooth'})}

// ===== EDIT CUSTOMER =====
function openEditCust(idx) {
  const c = allCustomers[idx];
  if (!c) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'); return; }
  document.getElementById('edit-cust-idx').value = idx;
  document.getElementById('edit-cust-title').textContent = c.name;
  document.getElementById('edit-cust-code').textContent = '‡∏£‡∏´‡∏±‡∏™: ' + c.code;
  document.getElementById('edit-cust-name').value = c.name || '';
  document.getElementById('edit-cust-phone').value = c.phone || '';
  document.getElementById('edit-cust-address').value = c.address || '';
  document.getElementById('edit-cust-taxid').value = c.taxId || '';
  document.getElementById('edit-cust-status').value = c.status || '‡∏õ‡∏Å‡∏ï‡∏¥';
  document.getElementById('edit-cust-accounting').value = c.accounting || '';
  document.getElementById('edit-cust-vat').value = c.vat || '';
  document.getElementById('edit-cust-wht').value = c.wht || '';
  document.getElementById('edit-cust-sbt').value = c.sbt || '';
  document.getElementById('edit-cust-pnd90').value = c.pnd90 || '';
  document.getElementById('edit-cust-audit').value = c.audit || '';
  openModal('edit-cust');
}

async function saveEditCust() {
  const idx = parseInt(document.getElementById('edit-cust-idx').value);
  const c = allCustomers[idx];
  if (!c || !c._rowIndex) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'); return; }
  const data = {
    rowIndex: c._rowIndex,
    name: document.getElementById('edit-cust-name').value.trim(),
    phone: document.getElementById('edit-cust-phone').value.trim(),
    address: document.getElementById('edit-cust-address').value.trim(),
    taxId: document.getElementById('edit-cust-taxid').value.trim(),
    status: document.getElementById('edit-cust-status').value,
    accounting: parseFloat(document.getElementById('edit-cust-accounting').value) || 0,
    vat: parseFloat(document.getElementById('edit-cust-vat').value) || 0,
    wht: parseFloat(document.getElementById('edit-cust-wht').value) || 0,
    sbt: parseFloat(document.getElementById('edit-cust-sbt').value) || 0,
    pnd90: parseFloat(document.getElementById('edit-cust-pnd90').value) || 0,
    audit: parseFloat(document.getElementById('edit-cust-audit').value) || 0
  };
  if (!data.name) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£'); return; }
  const r = await apiPost('updateCustomer', data);
  if (r && r.success) {
    alert('‚úÖ ' + r.message);
    closeModal('edit-cust');
    await loadCustomers(); // Reload to show updated data
  } else {
    alert('‚ùå ' + (r?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'));
  }
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',function(){const td=new Date().toISOString().split('T')[0];document.querySelectorAll('input[type="date"]').forEach(i=>{if(i.value)i.value=td})});

// ===== TAB SWITCHING =====
function switchInTab(btn,targetId){btn.parentElement.querySelectorAll('.in-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');const p=document.getElementById(targetId)?.parentElement;if(!p)return;const pf=targetId.split('-')[0]+'-';p.querySelectorAll(':scope > [id^="'+pf+'"]').forEach(d=>{d.style.display=d.id===targetId?'block':'none'})}

// ===== CONFIRM SUBMIT =====
async function confirmSubmit(){
  const si=document.querySelectorAll('.pay-item.sel');
  if(!si.length){alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');return}
  
  // Collect selected items
  const items=[];
  si.forEach(e=>items.push({month:e.dataset.month, serviceKey:e.dataset.svc, amount:parseFloat(e.dataset.amt||0)}));
  const totalItems=items.reduce((s,it)=>s+it.amount,0);
  
  // Collect ALL payment channels
  const channels = [];
  document.querySelectorAll('.pay-channel').forEach(ch => {
    const methodEl = ch.querySelector('.pay-opt.sel');
    const method = methodEl ? methodEl.querySelector('div:last-child').textContent.trim() : '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
    const amtEl = ch.querySelector('.pay-amt-input');
    const amt = amtEl ? parseFloat(amtEl.value.replace(/,/g,'')) || 0 : 0;
    const bankEl = ch.querySelector('select[id*="-bank"]');
    const bank = bankEl ? bankEl.value : '‚Äî';
    const refEl = ch.querySelector('input[id*="-ref"]');
    const ref = refEl ? refEl.value : '';
    const dateEl = ch.querySelector('input[type="date"]');
    const payDate = dateEl ? dateEl.value : '';
    if (amt > 0) channels.push({ method, amount: amt, bank, ref, payDate });
  });
  
  if (!channels.length || channels.reduce((s,c) => s + c.amount, 0) === 0) {
    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞');
    return;
  }
  
  const totalPaid = channels.reduce((s,c) => s + c.amount, 0);
  const channelSummary = channels.map(c => c.method + ' ' + fmtBaht(c.amount)).join(' + ');
  
  // For backward compatibility: main channel = first channel
  const channel = channels[0].method;
  const bank = channels[0].bank;
  const ref = channels[0].ref;
  
  const noteEl=document.querySelector('input[placeholder*="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"]');
  const note=noteEl?noteEl.value:'';
  
  // Confirm
  const monthList=[...new Set(items.map(it=>it.month))].join(', ');
  const diff = totalPaid - totalItems;
  const diffText = diff === 0 ? '‚úÖ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á' : diff > 0 ? 'üí∞ ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô ' + fmtBaht(diff) : '‚ö†Ô∏è ‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏î ' + fmtBaht(Math.abs(diff));
  if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?\n\n'+collectCustName+'\n'+items.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ('+monthList+')\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: '+fmtBaht(totalItems)+'\n‡∏ä‡∏≥‡∏£‡∏∞: '+channelSummary+'\n'+diffText))return;
  
  if(API_URL){
    const staffName=currentUser?currentUser.name:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    const r=await apiPost('savePayment',{
      custCode:collectCustCode, custName:collectCustName,
      channel, bank, ref, note, staff:staffName,
      channels, totalPaid,
      items
    });
    if(r&&r.success){
      alert('‚úÖ '+r.message);
      loadCollectItems(collectCustCode, collectCustName);
    } else {
      alert('‚ùå '+(r?.error||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'));
    }
  } else {
    alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å '+items.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Demo)');
  }
}
</script>
</body>
</html>
